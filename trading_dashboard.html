<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Enterprise Trading Analytics | Catalyst Radar</title>
    <script src="https://cdn.plot.ly/plotly-2.26.0.min.js"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Playfair+Display:wght@400;700&family=Inter:wght@300;400;500;600;700&display=swap');
        
        :root {
            --ft-primary: #000000;
            --ft-secondary: #1a1a1a;
            --ft-accent: #0050B3;
            --ft-text: #2E2E2E;
            --ft-text-light: #6B6B6B;
            --ft-bg: #FFFFFF;
            --ft-surface: #FAFAFA;
            --ft-border: #E5E5E5;
            --ft-green: #00A651;
            --ft-red: #DC143C;
            --ft-orange: #FF6B35;
            --ft-yellow: #FFC107;
            --ft-blue: #0050B3;
            --ft-purple: #6B46C1;
            --shadow-sm: 0 1px 3px rgba(0,0,0,0.08);
            --shadow-md: 0 4px 12px rgba(0,0,0,0.1);
            --shadow-lg: 0 8px 24px rgba(0,0,0,0.12);
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Inter', -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
            background: var(--ft-bg);
            color: var(--ft-text);
            line-height: 1.6;
            overflow-x: hidden;
        }

        .header {
            background: var(--ft-primary);
            color: white;
            padding: 16px 32px;
            border-bottom: 3px solid var(--ft-accent);
            display: flex;
            justify-content: space-between;
            align-items: center;
            position: sticky;
            top: 0;
            z-index: 100;
            box-shadow: var(--shadow-md);
        }

        .header h1 {
            font-family: 'Playfair Display', serif;
            font-size: 24px;
            font-weight: 700;
            letter-spacing: -0.5px;
        }

        .header-meta {
            display: flex;
            gap: 24px;
            font-size: 13px;
            font-weight: 500;
            opacity: 0.9;
        }

        .container {
            max-width: 1800px;
            margin: 0 auto;
            padding: 32px;
        }

        .top-bar {
            display: grid;
            grid-template-columns: 1fr auto;
            gap: 24px;
            margin-bottom: 32px;
            align-items: center;
        }

        .search-group {
            display: flex;
            gap: 12px;
            align-items: center;
        }

        .search-input {
            flex: 1;
            padding: 14px 20px;
            border: 2px solid var(--ft-border);
            border-radius: 4px;
            font-size: 16px;
            font-family: 'Inter', sans-serif;
            transition: border-color 0.2s;
        }

        .search-input:focus {
            outline: none;
            border-color: var(--ft-accent);
        }

        .btn-primary {
            padding: 14px 32px;
            background: var(--ft-accent);
            color: white;
            border: none;
            border-radius: 4px;
            font-size: 14px;
            font-weight: 600;
            cursor: pointer;
            transition: background 0.2s;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .btn-primary:hover {
            background: #003d8a;
        }

        .btn-secondary {
            padding: 14px 24px;
            background: transparent;
            color: var(--ft-text);
            border: 2px solid var(--ft-border);
            border-radius: 4px;
            font-size: 14px;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.2s;
        }

        .btn-secondary:hover {
            border-color: var(--ft-accent);
            color: var(--ft-accent);
        }

        .decision-bar {
            background: linear-gradient(135deg, #1a1a1a 0%, #2d2d2d 100%);
            color: white;
            padding: 24px 32px;
            border-radius: 8px;
            margin-bottom: 32px;
            display: grid;
            grid-template-columns: auto 1fr auto auto auto;
            gap: 32px;
            align-items: center;
            box-shadow: var(--shadow-lg);
        }

        .action-buttons {
            display: flex;
            gap: 8px;
            flex-wrap: wrap;
        }

        .action-btn {
            padding: 10px 16px;
            background: rgba(255,255,255,0.1);
            color: white;
            border: 1px solid rgba(255,255,255,0.2);
            border-radius: 4px;
            font-size: 12px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .action-btn:hover {
            background: rgba(255,255,255,0.2);
            border-color: rgba(255,255,255,0.4);
        }

        .action-btn.primary {
            background: var(--ft-green);
            border-color: var(--ft-green);
        }

        .action-btn.primary:hover {
            background: #00c463;
        }

        .triggered-conditions {
            display: flex;
            flex-wrap: wrap;
            gap: 8px;
            margin-top: 12px;
        }

        .trigger-badge {
            padding: 6px 12px;
            background: rgba(255,215,0,0.15);
            border: 1px solid #FFD700;
            border-radius: 4px;
            font-size: 11px;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            color: #FFD700;
            display: flex;
            align-items: center;
            gap: 6px;
        }

        .trigger-badge.high {
            background: rgba(220,20,60,0.15);
            border-color: var(--ft-red);
            color: var(--ft-red);
        }

        .trigger-badge.medium {
            background: rgba(255,165,0,0.15);
            border-color: #FFA500;
            color: #FFA500;
        }

        .trigger-badge.low {
            background: rgba(0,166,81,0.15);
            border-color: var(--ft-green);
            color: var(--ft-green);
        }

        /* Benchmarks & Deltas */
        .delta-badge {
            display: inline-flex;
            align-items: center;
            gap: 4px;
            font-size: 10px;
            font-weight: 600;
            padding: 2px 6px;
            border-radius: 3px;
            margin-left: 6px;
        }

        .delta-badge.positive {
            background: rgba(0,166,81,0.1);
            color: var(--ft-green);
        }

        .delta-badge.negative {
            background: rgba(220,20,60,0.1);
            color: var(--ft-red);
        }

        .delta-badge.neutral {
            background: rgba(107,107,107,0.1);
            color: var(--ft-text-light);
        }

        /* What-If Sliders */
        .what-if-panel {
            background: var(--ft-surface);
            border: 1px solid var(--ft-border);
            border-radius: 8px;
            padding: 20px;
            margin-bottom: 24px;
        }

        .slider-group {
            margin-bottom: 16px;
        }

        .slider-label {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 8px;
            font-size: 12px;
            font-weight: 600;
            text-transform: uppercase;
            color: var(--ft-text-light);
        }

        .slider-value {
            font-size: 14px;
            font-weight: 700;
            color: var(--ft-primary);
        }

        .slider-input {
            width: 100%;
            height: 6px;
            border-radius: 3px;
            background: var(--ft-border);
            outline: none;
            -webkit-appearance: none;
        }

        .slider-input::-webkit-slider-thumb {
            -webkit-appearance: none;
            appearance: none;
            width: 18px;
            height: 18px;
            border-radius: 50%;
            background: var(--ft-accent);
            cursor: pointer;
        }

        .slider-input::-moz-range-thumb {
            width: 18px;
            height: 18px;
            border-radius: 50%;
            background: var(--ft-accent);
            cursor: pointer;
            border: none;
        }

        /* Subscribe Toggles */
        .subscribe-toggle {
            display: flex;
            align-items: center;
            gap: 8px;
            padding: 8px 12px;
            background: white;
            border: 1px solid var(--ft-border);
            border-radius: 4px;
            cursor: pointer;
            transition: all 0.2s;
        }

        .subscribe-toggle:hover {
            border-color: var(--ft-accent);
            background: var(--ft-surface);
        }

        .subscribe-toggle.active {
            background: rgba(0,80,179,0.1);
            border-color: var(--ft-accent);
        }

        .toggle-switch {
            width: 40px;
            height: 20px;
            background: var(--ft-border);
            border-radius: 10px;
            position: relative;
            transition: background 0.2s;
        }

        .toggle-switch.active {
            background: var(--ft-green);
        }

        .toggle-switch::after {
            content: '';
            position: absolute;
            width: 16px;
            height: 16px;
            background: white;
            border-radius: 50%;
            top: 2px;
            left: 2px;
            transition: left 0.2s;
        }

        .toggle-switch.active::after {
            left: 22px;
        }

        .verdict-badge {
            font-family: 'Playfair Display', serif;
            font-size: 48px;
            font-weight: 700;
            text-transform: uppercase;
            letter-spacing: 2px;
        }

        .verdict-badge.BUY { color: var(--ft-green); }
        .verdict-badge.SELL { color: var(--ft-red); }
        .verdict-badge.SKIP { color: var(--ft-yellow); }

        .ticker-display {
            font-size: 32px;
            font-weight: 700;
            letter-spacing: -1px;
        }

        .confidence-meter {
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 8px;
        }

        .confidence-value {
            font-size: 36px;
            font-weight: 700;
            font-family: 'Playfair Display', serif;
        }

        .confidence-label {
            font-size: 11px;
            text-transform: uppercase;
            letter-spacing: 1px;
            opacity: 0.8;
        }

        .confidence-bar {
            width: 120px;
            height: 8px;
            background: rgba(255,255,255,0.2);
            border-radius: 4px;
            overflow: hidden;
            margin-top: 8px;
        }

        .confidence-fill {
            height: 100%;
            background: var(--ft-green);
            transition: width 0.5s;
        }

        .analytics-grid {
            display: grid;
            grid-template-columns: 2fr 1fr;
            gap: 24px;
            margin-bottom: 24px;
        }

        .analytics-main {
            display: flex;
            flex-direction: column;
            gap: 24px;
        }

        .analytics-sidebar {
            display: flex;
            flex-direction: column;
            gap: 24px;
        }

        .card {
            background: white;
            border: 1px solid var(--ft-border);
            border-radius: 8px;
            padding: 24px;
            box-shadow: var(--shadow-sm);
            transition: box-shadow 0.2s;
        }

        .card:hover {
            box-shadow: var(--shadow-md);
        }

        .card-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
            padding-bottom: 16px;
            border-bottom: 2px solid var(--ft-border);
        }

        .card-title {
            font-family: 'Playfair Display', serif;
            font-size: 20px;
            font-weight: 700;
            color: var(--ft-primary);
            letter-spacing: -0.3px;
        }

        .card-subtitle {
            font-size: 13px;
            color: var(--ft-text-light);
            text-transform: uppercase;
            letter-spacing: 0.5px;
            margin-top: 4px;
        }

        /* Key Metrics Bar - Investor-grade */
        .key-metrics-bar {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(140px, 1fr));
            gap: 1px;
            background: var(--ft-border);
            border-radius: 8px;
            overflow: hidden;
            margin-bottom: 24px;
        }

        .metric-item {
            background: white;
            padding: 16px;
            text-align: center;
            transition: background 0.2s;
        }

        .metric-item:hover {
            background: var(--ft-surface);
        }

        .metric-label {
            font-size: 11px;
            text-transform: uppercase;
            color: var(--ft-text-light);
            margin-bottom: 6px;
            font-weight: 600;
            letter-spacing: 0.5px;
        }

        .metric-value {
            font-size: 20px;
            font-weight: 700;
            color: var(--ft-primary);
            font-family: 'Playfair Display', serif;
        }

        .metric-value.positive { color: var(--ft-green); }
        .metric-value.negative { color: var(--ft-red); }
        .metric-value.neutral { color: var(--ft-text); }

        /* Compact Risk/Reward Panel */
        .risk-reward-panel {
            display: grid;
            grid-template-columns: 1fr auto 1fr;
            gap: 20px;
            align-items: center;
            padding: 20px;
            background: linear-gradient(135deg, rgba(0,166,81,0.05) 0%, rgba(220,20,60,0.05) 100%);
            border-radius: 8px;
            margin-bottom: 24px;
        }

        .risk-reward-panel-compact {
            background: white;
            border: 1px solid var(--ft-border);
            border-radius: 8px;
            padding: 16px;
            box-shadow: var(--shadow-sm);
        }

        .upside-box {
            text-align: right;
            padding-right: 20px;
            border-right: 2px solid var(--ft-green);
        }

        .downside-box {
            text-align: left;
            padding-left: 20px;
            border-left: 2px solid var(--ft-red);
        }

        .risk-label {
            font-size: 11px;
            text-transform: uppercase;
            font-weight: 600;
            letter-spacing: 0.5px;
            margin-bottom: 8px;
        }

        .risk-value {
            font-size: 32px;
            font-weight: 700;
            font-family: 'Playfair Display', serif;
        }

        .upside-box .risk-label { color: var(--ft-green); }
        .upside-box .risk-value { color: var(--ft-green); }
        .downside-box .risk-label { color: var(--ft-red); }
        .downside-box .risk-value { color: var(--ft-red); }

        .risk-ratio {
            text-align: center;
        }

        .risk-ratio-value {
            font-size: 48px;
            font-weight: 700;
            font-family: 'Playfair Display', serif;
            color: var(--ft-accent);
        }

        .risk-ratio-label {
            font-size: 12px;
            color: var(--ft-text-light);
            text-transform: uppercase;
            font-weight: 600;
        }

        /* Pattern vs Catalyst Comparison */
        .comparison-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px;
            margin-top: 20px;
        }

        .comparison-panel {
            padding: 20px;
            background: var(--ft-surface);
            border-radius: 6px;
            border-left: 4px solid var(--ft-accent);
        }

        .comparison-title {
            font-size: 14px;
            font-weight: 600;
            text-transform: uppercase;
            margin-bottom: 12px;
            color: var(--ft-accent);
        }

        .comparison-item {
            display: flex;
            justify-content: space-between;
            padding: 8px 0;
            border-bottom: 1px solid var(--ft-border);
        }

        .comparison-label {
            font-size: 13px;
            color: var(--ft-text-light);
        }

        .comparison-value {
            font-size: 14px;
            font-weight: 600;
        }

        /* Meme Signal Indicator */
        .meme-signal {
            background: linear-gradient(135deg, rgba(255,107,53,0.2) 0%, rgba(255,193,7,0.2) 100%);
            border: 2px solid var(--ft-orange);
            padding: 20px;
            border-radius: 8px;
            text-align: center;
        }

        .meme-signal.active {
            background: linear-gradient(135deg, rgba(255,107,53,0.3) 0%, rgba(255,193,7,0.3) 100%);
            border-color: var(--ft-red);
        }

        .meme-icon {
            font-size: 48px;
            margin-bottom: 12px;
        }

        .meme-text {
            font-size: 18px;
            font-weight: 700;
            color: var(--ft-orange);
        }

        .meme-signal.active .meme-text {
            color: var(--ft-red);
        }

        /* Chart Container */
        .chart-container {
            width: 100%;
            min-width: 100%;
            height: 450px;
            min-height: 450px;
            margin-top: 16px;
            background: #FFFFFF;
            border-radius: 6px;
            position: relative;
            overflow: hidden;
        }
        
        .chart-container svg {
            width: 100% !important;
            height: 100% !important;
        }
        
        /* Ensure Plotly container has dimensions */
        .chart-container > div {
            width: 100% !important;
            height: 100% !important;
        }

        .indicator-explanation {
            margin-top: 16px;
            padding: 16px;
            background: var(--ft-surface);
            border-radius: 6px;
            font-size: 13px;
            line-height: 1.6;
        }

        .indicator-explanation h4 {
            font-size: 14px;
            font-weight: 600;
            margin-bottom: 8px;
            color: var(--ft-primary);
        }

        .trade-plan-grid {
            display: grid;
            grid-template-columns: repeat(4, 1fr);
            gap: 20px;
        }

        .trade-metric {
            text-align: center;
            padding: 16px;
            background: var(--ft-surface);
            border-radius: 6px;
        }

        .trade-metric-label {
            font-size: 11px;
            text-transform: uppercase;
            letter-spacing: 1px;
            color: var(--ft-text-light);
            margin-bottom: 8px;
        }

        .trade-metric-value {
            font-size: 24px;
            font-weight: 700;
            color: var(--ft-primary);
            font-family: 'Playfair Display', serif;
        }

        .pattern-analysis {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px;
        }

        .pattern-item {
            padding: 16px;
            background: var(--ft-surface);
            border-radius: 6px;
        }

        .pattern-label {
            font-size: 12px;
            color: var(--ft-text-light);
            margin-bottom: 8px;
        }

        .pattern-value {
            font-size: 20px;
            font-weight: 600;
        }

        .price-position-bar {
            width: 100%;
            height: 12px;
            background: var(--ft-border);
            border-radius: 6px;
            overflow: hidden;
            margin-top: 12px;
            position: relative;
        }

        .price-position-fill {
            height: 100%;
            background: linear-gradient(90deg, var(--ft-red) 0%, var(--ft-yellow) 50%, var(--ft-green) 100%);
            transition: width 0.5s;
        }

        .price-position-marker {
            position: absolute;
            top: 0;
            width: 3px;
            height: 100%;
            background: var(--ft-primary);
            transform: translateX(-50%);
        }

        .volume-metrics {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 16px;
        }

        .volume-metric {
            padding: 16px;
            background: var(--ft-surface);
            border-radius: 6px;
        }

        .volume-label {
            font-size: 12px;
            color: var(--ft-text-light);
            margin-bottom: 8px;
        }

        .volume-value {
            font-size: 22px;
            font-weight: 700;
        }

        .surge-badge {
            display: inline-block;
            padding: 4px 12px;
            border-radius: 12px;
            font-size: 11px;
            font-weight: 600;
            margin-left: 8px;
        }

        .surge-badge.high {
            background: var(--ft-green);
            color: white;
        }

        .surge-badge.medium {
            background: var(--ft-yellow);
            color: var(--ft-primary);
        }

        .surge-badge.low {
            background: var(--ft-red);
            color: white;
        }

        .catalyst-card {
            background: linear-gradient(135deg, rgba(0,80,179,0.1) 0%, rgba(107,70,193,0.1) 100%);
            border-left: 4px solid var(--ft-accent);
            padding: 20px;
            border-radius: 6px;
        }

        .catalyst-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 16px;
        }

        .catalyst-type {
            font-size: 14px;
            font-weight: 600;
            text-transform: uppercase;
            color: var(--ft-accent);
        }

        .catalyst-days {
            font-size: 32px;
            font-weight: 700;
            font-family: 'Playfair Display', serif;
            color: var(--ft-primary);
        }

        .reasoning-section {
            background: var(--ft-surface);
            padding: 24px;
            border-radius: 8px;
            border-left: 4px solid var(--ft-accent);
        }

        .reasoning-text {
            font-size: 15px;
            line-height: 1.8;
            color: var(--ft-text);
            font-style: italic;
        }

        .perf-grid {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 16px;
        }

        .perf-stat {
            padding: 16px;
            background: var(--ft-surface);
            border-radius: 6px;
            text-align: center;
        }

        .perf-label {
            font-size: 11px;
            text-transform: uppercase;
            color: var(--ft-text-light);
            margin-bottom: 8px;
        }

        .perf-value {
            font-size: 24px;
            font-weight: 700;
            font-family: 'Playfair Display', serif;
        }

        .strategy-card {
            background: linear-gradient(135deg, rgba(0,166,81,0.05) 0%, rgba(0,80,179,0.05) 100%);
            border-left: 4px solid var(--ft-green);
            padding: 20px;
            border-radius: 6px;
        }

        .strategy-arm {
            font-size: 16px;
            font-weight: 700;
            color: var(--ft-primary);
            margin-bottom: 12px;
        }

        .strategy-reason {
            font-size: 14px;
            line-height: 1.6;
            color: var(--ft-text);
            margin-bottom: 16px;
        }

        .gating-facts {
            display: flex;
            flex-direction: column;
            gap: 8px;
        }

        .gating-fact {
            display: flex;
            align-items: center;
            gap: 8px;
            font-size: 13px;
        }

        .gating-fact::before {
            content: '‚úì';
            color: var(--ft-green);
            font-weight: 700;
            font-size: 16px;
        }

        .news-list {
            display: flex;
            flex-direction: column;
            gap: 12px;
            max-height: 300px;
            overflow-y: auto;
        }

        .news-item {
            padding: 12px;
            background: var(--ft-surface);
            border-radius: 6px;
            border-left: 3px solid transparent;
            transition: all 0.2s;
        }

        .news-item:hover {
            border-left-color: var(--ft-accent);
            background: white;
        }

        .news-headline {
            font-size: 14px;
            font-weight: 500;
            margin-bottom: 4px;
        }

        .news-meta {
            font-size: 11px;
            color: var(--ft-text-light);
            display: flex;
            justify-content: space-between;
        }

        .sentiment-badge {
            display: inline-block;
            padding: 2px 8px;
            border-radius: 10px;
            font-size: 10px;
            font-weight: 600;
        }

        .sentiment-badge.positive {
            background: var(--ft-green);
            color: white;
        }

        .sentiment-badge.negative {
            background: var(--ft-red);
            color: white;
        }

        .sentiment-badge.neutral {
            background: var(--ft-border);
            color: var(--ft-text);
        }

        /* Evidence Cards */
        .evidence-panel {
            display: flex;
            flex-direction: column;
            gap: 16px;
        }

        .evidence-test {
            padding: 16px;
            background: var(--ft-surface);
            border-radius: 6px;
            border-left: 3px solid var(--ft-accent);
        }

        .evidence-header {
            display: flex;
            align-items: center;
            gap: 12px;
            margin-bottom: 8px;
        }

        .evidence-name {
            font-size: 14px;
            font-weight: 600;
            color: var(--ft-primary);
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .evidence-badge {
            padding: 2px 8px;
            border-radius: 12px;
            font-size: 11px;
            font-weight: 700;
        }

        .evidence-badge.A {
            background: var(--ft-green);
            color: white;
        }

        .evidence-badge.B {
            background: var(--ft-yellow);
            color: var(--ft-primary);
        }

        .evidence-badge.C {
            background: var(--ft-border);
            color: var(--ft-text);
        }

        .significance-badge {
            padding: 2px 6px;
            background: var(--ft-purple);
            color: white;
            border-radius: 4px;
            font-size: 10px;
            font-weight: 600;
        }

        .evidence-hypothesis {
            font-size: 13px;
            color: var(--ft-text);
            margin-bottom: 8px;
            font-style: italic;
        }

        .evidence-effect {
            display: flex;
            align-items: center;
            gap: 8px;
            margin-bottom: 4px;
        }

        .effect-label {
            font-size: 12px;
            color: var(--ft-text-light);
        }

        .effect-value {
            font-size: 14px;
            font-weight: 600;
            color: var(--ft-primary);
        }

        .effect-ci {
            font-size: 11px;
            color: var(--ft-text-light);
            font-family: 'Courier New', monospace;
        }

        .evidence-pvalue {
            display: flex;
            align-items: center;
            gap: 8px;
            margin-bottom: 4px;
        }

        .pvalue-label {
            font-size: 12px;
            color: var(--ft-text-light);
        }

        .pvalue-value {
            font-size: 14px;
            font-weight: 600;
            color: var(--ft-text);
        }

        .pvalue-value.significant {
            color: var(--ft-green);
        }

        .evidence-notes {
            font-size: 11px;
            color: var(--ft-text-light);
            margin-top: 8px;
            padding-top: 8px;
            border-top: 1px solid var(--ft-border);
        }

        .calibration-metrics {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 12px;
            padding: 16px;
            background: var(--ft-surface);
            border-radius: 6px;
            margin-top: 16px;
        }

        .calibration-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .calibration-label {
            font-size: 12px;
            color: var(--ft-text-light);
        }

        .calibration-value {
            font-size: 14px;
            font-weight: 600;
            color: var(--ft-primary);
        }

        .assumptions-warning {
            padding: 12px;
            background: rgba(255,193,7,0.1);
            border-left: 3px solid var(--ft-yellow);
            border-radius: 4px;
            font-size: 12px;
            color: var(--ft-text);
            margin-top: 16px;
        }

        .empty-state {
            text-align: center;
            padding: 80px 40px;
            color: var(--ft-text-light);
        }

        .empty-state-icon {
            font-size: 64px;
            margin-bottom: 24px;
            opacity: 0.3;
        }

        .empty-state-title {
            font-family: 'Playfair Display', serif;
            font-size: 28px;
            margin-bottom: 12px;
            color: var(--ft-text);
        }

        .loading {
            display: flex;
            justify-content: center;
            align-items: center;
            padding: 80px;
        }

        .spinner {
            width: 48px;
            height: 48px;
            border: 4px solid var(--ft-border);
            border-top-color: var(--ft-accent);
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }

        @keyframes spin {
            to { transform: rotate(360deg); }
        }

        ::-webkit-scrollbar {
            width: 8px;
            height: 8px;
        }

        ::-webkit-scrollbar-track {
            background: var(--ft-surface);
        }

        ::-webkit-scrollbar-thumb {
            background: var(--ft-border);
            border-radius: 4px;
        }

        ::-webkit-scrollbar-thumb:hover {
            background: var(--ft-text-light);
        }
    </style>
</head>
<body>
    <div class="header">
        <h1>Catalyst Radar</h1>
        <div class="header-meta">
            <span id="current-time"></span>
            <span>Enterprise Analytics Platform</span>
        </div>
    </div>

    <div class="container">
        <!-- DEBUG PANEL (Only shown with ?debug=1) -->
        <div id="debug-panel" style="display: none; background: #1a1a1a; color: #00ff00; padding: 20px; border-radius: 8px; margin-bottom: 20px; font-family: monospace; font-size: 12px; max-height: 200px; overflow-y: auto;">
            <div style="color: #ffff00; font-weight: bold; margin-bottom: 10px;">üîç DIAGNOSTIC PANEL (Live Debug Info) - Add ?debug=1 to URL to enable</div>
            <div id="debug-output">Waiting for activity...</div>
        </div>
        
        <div class="top-bar">
            <div class="search-group">
                <input type="text" id="ticker-input" class="search-input" placeholder="Enter ticker symbol (e.g., NVDA, TSLA, AAPL)" onkeypress="if(event.key==='Enter') analyzeStock()">
                <button class="btn-primary" onclick="analyzeStock()">Analyze</button>
            </div>
            <div>
                <button class="btn-secondary" onclick="fetchScanList()">Refresh Opportunities</button>
            </div>
        </div>

        <div id="dashboard-content">
            <div class="empty-state">
                <div class="empty-state-icon">üìä</div>
                <div class="empty-state-title">Enterprise Trading Analytics</div>
                <div class="empty-state-text">Enter a ticker symbol above or select from opportunities to begin comprehensive analysis.</div>
            </div>
        </div>
    </div>

    <script>
        // API Configuration - Environment-driven with fallback
        const API_BASE = window.location.hostname === 'localhost' || window.location.hostname === '127.0.0.1'
            ? 'http://127.0.0.1:8000'
            : (window.API_BASE_URL || 'http://127.0.0.1:8000');
        
        // Debug mode - only show panel if ?debug=1 in URL
        const urlParams = new URLSearchParams(window.location.search);
        const DEBUG_MODE = urlParams.get('debug') === '1';
        
        let currentAnalysis = null;
        let priceChart = null;
        let rsiChart = null;
        
        // DEBUG LOGGER - Only logs if debug panel exists
        function debugLog(message, type = 'info') {
            const output = document.getElementById('debug-output');
            if (!output) {
                // Always log to console, but only show on page if debug panel exists
                console.log(`[${new Date().toLocaleTimeString()}] ${message}`);
                return;
            }
            
            const timestamp = new Date().toLocaleTimeString();
            const icon = type === 'error' ? '‚ùå' : type === 'success' ? '‚úÖ' : type === 'warn' ? '‚ö†Ô∏è' : '‚ÑπÔ∏è';
            const color = type === 'error' ? '#ff4444' : type === 'success' ? '#00ff00' : type === 'warn' ? '#ffaa00' : '#00ffff';
            
            const line = document.createElement('div');
            line.style.color = color;
            line.style.marginBottom = '5px';
            line.textContent = `[${timestamp}] ${icon} ${message}`;
            
            output.appendChild(line);
            output.scrollTop = output.scrollHeight;
            
            // Also log to real console
            console.log(`[${timestamp}] ${message}`);
        }
        
        // Test on load - only if debug mode
        window.addEventListener('DOMContentLoaded', () => {
            // Show debug panel if debug mode enabled
            const debugPanel = document.getElementById('debug-panel');
            if (DEBUG_MODE && debugPanel) {
                debugPanel.style.display = 'block';
                debugLog('Page loaded successfully', 'success');
                debugLog(`Plotly library: ${typeof Plotly !== 'undefined' ? 'LOADED ‚úì' : 'NOT LOADED ‚úó'}`, typeof Plotly !== 'undefined' ? 'success' : 'error');
                debugLog(`API endpoint: ${API_BASE}`, 'info');
                
                // Test API connection
                fetch(`${API_BASE}/`)
                    .then(r => {
                        if (r.ok) {
                            debugLog('‚úì Backend server is RUNNING', 'success');
                        } else {
                            debugLog('‚úó Backend returned error: ' + r.status, 'error');
                        }
                    })
                    .catch(e => {
                        debugLog('‚úó BACKEND NOT RUNNING! Start with: uvicorn apps.api.main:app --reload', 'error');
                    });
            } else {
                console.log(`[${new Date().toLocaleTimeString()}] Dashboard loaded (debug mode: off)`);
            }
        });

        function updateTime() {
            const now = new Date();
            document.getElementById('current-time').textContent = now.toLocaleString('en-US', {
                weekday: 'short',
                month: 'short',
                day: 'numeric',
                hour: '2-digit',
                minute: '2-digit'
            });
        }
        updateTime();
        setInterval(updateTime, 60000);

        // Render Plotly Price Chart
        function renderPriceChart(historyData) {
            debugLog(`renderPriceChart called with ${historyData?.data?.length || 0} data points`, 'info');
            if (!historyData || !historyData.data) {
                debugLog('No history data for price chart', 'warn');
                return;
            }
            
            const chartElement = document.getElementById('price-chart');
            if (!chartElement) {
                console.warn('Price chart element not found');
                return;
            }
            
            if (typeof Plotly === 'undefined') {
                console.error('Plotly library not loaded');
                return;
            }
            
            const data = historyData.data;
            if (!data || data.length === 0) {
                console.warn('Empty data array');
                return;
            }
            
            const dates = data.map(d => d.date);
            const closes = data.map(d => d.close);
            
            // Filter out null values for SMAs
            const sma20Data = data.filter(d => d.sma_20 !== null && d.sma_20 !== undefined);
            const sma50Data = data.filter(d => d.sma_50 !== null && d.sma_50 !== undefined);
            
            const support = historyData.indicators?.support || closes[closes.length - 1];
            const resistance = historyData.indicators?.resistance || closes[closes.length - 1];
            
            // Ensure all values are numeric (filter out any NaN/Inf)
            const validIndices = [];
            for (let i = 0; i < dates.length; i++) {
                if (dates[i] && closes[i] !== null && closes[i] !== undefined && 
                    !isNaN(closes[i]) && isFinite(closes[i])) {
                    validIndices.push(i);
                }
            }
            
            const validDates = validIndices.map(i => dates[i]);
            const validCloses = validIndices.map(i => closes[i]);
            
            // Additional validation: ensure we have at least 2 data points
            if (validDates.length < 2 || validCloses.length < 2) {
                console.error('‚ùå Insufficient valid data points for price chart');
                chartElement.innerHTML = `<div style="padding: 20px; color: var(--ft-text-light);">Insufficient data: need at least 2 data points</div>`;
                return;
            }
            
            const traces = [
                {
                    x: validDates,
                    y: validCloses,
                    type: 'scatter',
                    mode: 'lines',
                    name: 'Close Price',
                    line: { color: '#0050B3', width: 2 },
                    hovertemplate: '<b>%{fullData.name}</b><br>Date: %{x}<br>Price: $%{y:.2f}<extra></extra>'
                }
            ];
            
            // Add SMA20 if available
            if (sma20Data.length > 0) {
                const sma20Dates = sma20Data.map(d => d.date);
                const sma20Values = sma20Data.map(d => d.sma_20).filter(v => v !== null && !isNaN(v) && isFinite(v));
                if (sma20Values.length > 0) {
                    traces.push({
                        x: sma20Dates.slice(-sma20Values.length),
                        y: sma20Values,
                        type: 'scatter',
                        mode: 'lines',
                        name: 'SMA 20',
                        line: { color: '#FF6B35', width: 1.5, dash: 'dot' }
                    });
                }
            }
            
            // Add SMA50 if available
            if (sma50Data.length > 0) {
                const sma50Dates = sma50Data.map(d => d.date);
                const sma50Values = sma50Data.map(d => d.sma_50).filter(v => v !== null && !isNaN(v) && isFinite(v));
                if (sma50Values.length > 0) {
                    traces.push({
                        x: sma50Dates.slice(-sma50Values.length),
                        y: sma50Values,
                        type: 'scatter',
                        mode: 'lines',
                        name: 'SMA 50',
                        line: { color: '#6B46C1', width: 1.5, dash: 'dot' }
                    });
                }
            }
            
            // Add support/resistance lines
            if (validDates.length > 0 && support && resistance && 
                isFinite(support) && isFinite(resistance)) {
                traces.push({
                    x: [validDates[0], validDates[validDates.length - 1]],
                    y: [support, support],
                    type: 'scatter',
                    mode: 'lines',
                    name: 'Support',
                    line: { color: '#00A651', width: 2, dash: 'dash' }
                });
                
                traces.push({
                    x: [validDates[0], validDates[validDates.length - 1]],
                    y: [resistance, resistance],
                    type: 'scatter',
                    mode: 'lines',
                    name: 'Resistance',
                    line: { color: '#DC143C', width: 2, dash: 'dash' }
                });
            }
            
            const layout = {
                title: {
                    text: 'Price Action with Technical Indicators',
                    font: { family: 'Playfair Display', size: 20 },
                    x: 0.5,
                    xanchor: 'center'
                },
                xaxis: { 
                    title: 'Date',
                    showgrid: true,
                    gridcolor: 'rgba(0,0,0,0.1)',
                    zeroline: false
                },
                yaxis: { 
                    title: 'Price ($)',
                    side: 'left',
                    showgrid: true,
                    gridcolor: 'rgba(0,0,0,0.1)',
                    zeroline: false
                },
                hovermode: 'x unified',
                showlegend: true,
                legend: { x: 0, y: 1, bgcolor: 'rgba(255,255,255,0.8)' },
                margin: { l: 60, r: 50, t: 60, b: 60 },
                plot_bgcolor: '#FFFFFF',
                paper_bgcolor: '#FFFFFF',
                font: { family: 'Inter', size: 12, color: '#2E2E2E' }
            };
            
            // Verify container exists and has dimensions
            const containerHeight = chartElement.offsetHeight;
            const containerWidth = chartElement.offsetWidth;
            console.log('Container dimensions:', { width: containerWidth, height: containerHeight });
            
            if (containerHeight === 0 || containerWidth === 0) {
                console.error('‚ùå Chart container has zero dimensions!');
                chartElement.style.height = '450px';
                chartElement.style.width = '100%';
            }
            
            try {
                debugLog(`Rendering price chart: ${traces.length} traces, ${validDates.length} data points`, 'info');
                
                // Clear any existing plot
                Plotly.purge('price-chart');
                
                // Render with full controls (zoom, pan, reset, auto-scale)
                Plotly.newPlot('price-chart', traces, layout, {
                    responsive: true,
                    displayModeBar: true,
                    displaylogo: false,
                    modeBarButtonsToRemove: ['lasso2d', 'select2d'],
                    toImageButtonOptions: {
                        format: 'png',
                        filename: 'price_chart',
                        height: 600,
                        width: 1200,
                        scale: 2
                    },
                    autosize: true
                });
                
                // Force resize after render
                setTimeout(() => {
                    Plotly.Plots.resize('price-chart');
                }, 100);
                
                debugLog('‚úÖ Price chart rendered successfully!', 'success');
            } catch (error) {
                debugLog('‚ùå Error rendering price chart: ' + error.message, 'error');
                chartElement.innerHTML = `<div style="padding: 20px; color: red;">Chart rendering error: ${error.message}</div>`;
            }
        }

        // Render RSI Chart
        function renderRSIChart(historyData) {
            if (!historyData || !historyData.data) {
                console.warn('No history data for RSI chart');
                return;
            }
            
            const chartElement = document.getElementById('rsi-chart');
            if (!chartElement) {
                console.warn('RSI chart element not found');
                return;
            }
            
            if (typeof Plotly === 'undefined') {
                console.error('Plotly library not loaded');
                return;
            }
            
            const data = historyData.data;
            if (!data || data.length === 0) {
                console.warn('Empty data array for RSI');
                return;
            }
            
            const rsiData = data.filter(d => d.rsi !== null && d.rsi !== undefined);
            if (rsiData.length === 0) {
                console.warn('No RSI data available');
                return;
            }
            
            const rsiDates = rsiData.map(d => d.date);
            const rsi = rsiData.map(d => d.rsi).filter(v => v !== null && !isNaN(v) && isFinite(v));
            
            // Additional validation: ensure we have valid RSI data
            if (rsiDates.length < 2 || rsi.length < 2) {
                console.error('‚ùå Insufficient valid RSI data points');
                chartElement.innerHTML = `<div style="padding: 20px; color: var(--ft-text-light);">Insufficient RSI data: need at least 2 data points</div>`;
                return;
            }
            
            const traces = [
                {
                    x: rsiDates.slice(0, rsi.length), // Match lengths
                    y: rsi,
                    type: 'scatter',
                    mode: 'lines',
                    name: 'RSI(14)',
                    line: { color: '#0050B3', width: 2 },
                    fill: 'tozeroy',
                    fillcolor: 'rgba(0,80,179,0.1)',
                    hovertemplate: '<b>RSI(14)</b><br>Date: %{x}<br>RSI: %{y:.2f}<extra></extra>'
                }
            ];
            
            if (rsiDates.length > 0) {
                traces.push({
                    x: [rsiDates[0], rsiDates[rsiDates.length - 1]],
                    y: [70, 70],
                    type: 'scatter',
                    mode: 'lines',
                    name: 'Overbought (70)',
                    line: { color: '#DC143C', width: 1, dash: 'dash' }
                });
                
                traces.push({
                    x: [rsiDates[0], rsiDates[rsiDates.length - 1]],
                    y: [30, 30],
                    type: 'scatter',
                    mode: 'lines',
                    name: 'Oversold (30)',
                    line: { color: '#00A651', width: 1, dash: 'dash' }
                });
            }
            
            const layout = {
                title: {
                    text: 'RSI(14) Momentum Indicator',
                    font: { family: 'Playfair Display', size: 18 }
                },
                xaxis: { 
                    title: 'Date',
                    showgrid: true,
                    gridcolor: 'rgba(0,0,0,0.1)',
                    zeroline: false
                },
                yaxis: { 
                    title: 'RSI', 
                    range: [0, 100],
                    side: 'left',
                    showgrid: true,
                    gridcolor: 'rgba(0,0,0,0.1)',
                    zeroline: false
                },
                hovermode: 'x unified',
                showlegend: true,
                legend: { x: 0, y: 1, bgcolor: 'rgba(255,255,255,0.8)' },
                margin: { l: 60, r: 50, t: 60, b: 60 },
                plot_bgcolor: '#FFFFFF',
                paper_bgcolor: '#FFFFFF',
                font: { family: 'Inter', size: 12, color: '#2E2E2E' }
            };
            
            // Verify container exists and has dimensions
            const containerHeight = chartElement.offsetHeight;
            const containerWidth = chartElement.offsetWidth;
            console.log('RSI Container dimensions:', { width: containerWidth, height: containerHeight });
            
            if (containerHeight === 0 || containerWidth === 0) {
                console.error('‚ùå RSI Chart container has zero dimensions!');
                chartElement.style.height = '450px';
                chartElement.style.width = '100%';
            }
            
            try {
                console.log('Rendering RSI chart with', traces.length, 'traces');
                console.log('RSI data sample:', {
                    rsiLength: rsi.length,
                    datesLength: rsiDates.length,
                    firstRSI: rsi[0],
                    lastRSI: rsi[rsi.length - 1]
                });
                
                // Clear any existing plot
                Plotly.purge('rsi-chart');
                
                // Render with full controls (zoom, pan, reset, auto-scale)
                Plotly.newPlot('rsi-chart', traces, layout, {
                    responsive: true,
                    displayModeBar: true,
                    displaylogo: false,
                    modeBarButtonsToRemove: ['lasso2d', 'select2d'],
                    toImageButtonOptions: {
                        format: 'png',
                        filename: 'rsi_chart',
                        height: 600,
                        width: 1200,
                        scale: 2
                    },
                    autosize: true
                });
                
                // Force resize after render
                setTimeout(() => {
                    Plotly.Plots.resize('rsi-chart');
                }, 100);
                
                console.log('‚úÖ RSI chart rendered');
            } catch (error) {
                console.error('‚ùå Error rendering RSI chart:', error);
                console.error('Trace data:', traces);
                console.error('Layout:', layout);
                // Show error message in container
                chartElement.innerHTML = `<div style="padding: 20px; color: red;">Chart rendering error: ${error.message}</div>`;
            }
        }

        // Render Enterprise Dashboard with all new features
        async function renderAnalysis(data) {
            const content = document.getElementById('dashboard-content');
            const plan = data.plan || {};
            const analysis = data.analysis || {};
            const catalyst = analysis.catalyst || {};
            const strategy = analysis.strategy || {};
            const market = analysis.market || {};
            const news = analysis.news || [];
            const history = analysis.history || {};
            const social = JSON.parse(plan.social_sentiment || '{}');

            const ticker = analysis.ticker || plan.ticker;
            
            // Extract confidence from multiple possible locations with debugging - MUST BE BEFORE ANY USE
            const rawConfidence = plan.confidence !== undefined && plan.confidence !== null ? plan.confidence :
                                 analysis.llm_confidence !== undefined && analysis.llm_confidence !== null ? analysis.llm_confidence :
                                 data.plan?.confidence !== undefined && data.plan?.confidence !== null ? data.plan.confidence :
                                 data.analysis?.llm_confidence !== undefined && data.analysis?.llm_confidence !== null ? data.analysis.llm_confidence :
                                 0.5;
            
            const finalConfidence = Math.max(0.0, Math.min(1.0, rawConfidence));
            
            // Debug confidence extraction
            console.log('Confidence extraction:', {
                'plan.confidence': plan.confidence,
                'analysis.llm_confidence': analysis.llm_confidence,
                'data.plan?.confidence': data.plan?.confidence,
                'data.analysis?.llm_confidence': data.analysis?.llm_confidence,
                'rawConfidence': rawConfidence,
                'finalConfidence': finalConfidence
            });
            
            // Fetch surge analysis and history data
            let surgeData = null;
            let historyData = null;
            
            try {
                debugLog(`Fetching /surge/${ticker} and /history/${ticker}...`, 'info');
                const [surgeRes, historyRes] = await Promise.all([
                    fetch(`${API_BASE}/surge/${ticker}`),
                    fetch(`${API_BASE}/history/${ticker}?days=30`)
                ]);
                
                if (surgeRes.ok) {
                    surgeData = await surgeRes.json();
                    debugLog(`‚úÖ Surge data loaded`, 'success');
                } else {
                    debugLog(`‚ö†Ô∏è Surge endpoint failed: ${surgeRes.status}`, 'warn');
                }
                
                if (historyRes.ok) {
                    historyData = await historyRes.json();
                    debugLog(`‚úÖ History data loaded: ${historyData.data?.length || 0} data points`, 'success');
                } else {
                    const errorText = await historyRes.text();
                    debugLog(`‚ùå /history/${ticker} failed: ${historyRes.status} - ${errorText}`, 'error');
                }
            } catch (e) {
                debugLog(`‚ùå Error fetching surge/history: ${e.message}`, 'error');
            }

            // Calculate derived metrics
            const pricePosition = (plan.price_position || 0.5) * 100;
            const volumeSurge = plan.volume_surge_ratio || 1.0;
            const expectedMove = (catalyst.expected_move || 0) * 100;
            const materiality = (catalyst.materiality || 0) * 100;
            
            // Meme signal detection
            const memeSignal = surgeData?.social?.meme_signal || 
                (social.mention_count_total > 50 && social.sentiment_score > 0.5);
            
            // Pattern vs Catalyst analysis
            const patternExpectation = pricePosition > 80 ? 'Breakout Expected' : 
                                      pricePosition < 20 ? 'Bounce Expected' : 'Range Bound';
            const catalystExpectation = catalyst.days_to_event < 7 ? 'High Impact' : 
                                       catalyst.days_to_event < 30 ? 'Moderate Impact' : 'Low Near-term Impact';
            const alignment = (patternExpectation.includes('Breakout') && catalyst.days_to_event < 7) ? 'ALIGNED' :
                             (patternExpectation.includes('Bounce') && catalyst.days_to_event < 30) ? 'ALIGNED' : 'MISALIGNED';
            
            // Evaluate triggered conditions
            const triggers = evaluateTriggeredConditions({
                rsi: market.rsi14 || 50,
                volumeSurge: volumeSurge,
                daysToEvent: catalyst.days_to_event || 999,
                expectedMove: expectedMove,
                pricePosition: pricePosition,
                socialMentions: social.mention_count_total || 0,
                                confidence: finalConfidence
            });
            
            // Safe Risk/Reward calculation
            const riskRewardRatio = safeRiskRewardRatio(
                plan.target_price,
                market.price || plan.entry_price,
                plan.stop_price
            );
            const riskRewardDisplay = riskRewardRatio ? riskRewardRatio.toFixed(1) + ':1' : 'N/A';
            
            // Safe percentage calculations
            const upsidePct = plan.target_price && market.price ? 
                ((plan.target_price - market.price) / market.price * 100).toFixed(1) : 'N/A';
            const downsidePct = plan.stop_price && market.price ? 
                ((plan.stop_price - market.price) / market.price * 100).toFixed(1) : 'N/A';
            
            // Calculate benchmark deltas (90-day medians - simulated for now)
            // In production, fetch from /benchmarks/{ticker} endpoint
            const rsi90dMedian = 50; // Typical RSI median
            const volSurge90dMedian = 1.2; // Typical volume surge
            const rsiDelta = market.rsi14 ? market.rsi14 - rsi90dMedian : 0;
            const volSurgeDelta = volumeSurge - volSurge90dMedian;
            
            const formatDelta = (delta, unit = '') => {
                if (delta === 0) return { text: '¬±0', class: 'neutral' };
                const sign = delta > 0 ? '+' : '';
                const absDelta = Math.abs(delta);
                return {
                    text: `${sign}${absDelta.toFixed(1)}${unit}`,
                    class: delta > 0 ? 'positive' : 'negative'
                };
            };
            
            const rsiDeltaFormatted = formatDelta(rsiDelta);
            const volSurgeDeltaFormatted = formatDelta(volSurgeDelta, 'x');
            
            // Store current market price for what-if calculations
            const currentMarketPrice = market.price || plan.entry_price;
            
            // Subscribe state management (initialize all to false)
            const subscribeState = {
                rsi: false,
                pricePosition: false,
                socialMentions: false,
                volumeSurge: false,
                eventApproach: false
            };

                content.innerHTML = `
                    <!-- Decision Bar -->
                    <div class="decision-bar">
                        <div class="verdict-badge ${plan.action}">${plan.action}</div>
                        <div>
                            <div class="ticker-display">${ticker}</div>
                            <div style="font-size: 14px; opacity: 0.8; margin-top: 4px;">${strategy.reason || 'No strategy rationale available for ' + ticker}</div>
                            ${triggers.length > 0 ? `
                            <div class="triggered-conditions">
                                ${triggers.slice(0, 3).map(t => `
                                    <div class="trigger-badge ${t.severity}" title="${t.description}">
                                        ${t.severity === 'high' ? 'üî¥' : t.severity === 'medium' ? 'üü°' : 'üü¢'} ${t.name}
                                    </div>
                                `).join('')}
                            </div>
                            ` : ''}
                        </div>
                        <div class="confidence-meter">
                            <div class="confidence-value">${Math.round(finalConfidence * 100)}%</div>
                            <div class="confidence-label">Confidence</div>
                            <div class="confidence-bar">
                                <div class="confidence-fill" style="width: ${finalConfidence * 100}%"></div>
                            </div>
                        </div>
                        <div style="text-align: right;">
                            <div style="font-size: 32px; font-weight: 700; font-family: 'Playfair Display', serif;">$${market.price?.toFixed(2) || plan.entry_price?.toFixed(2) || 'N/A'}</div>
                            <div style="font-size: 12px; opacity: 0.8; margin-top: 4px;">Current Price</div>
                        </div>
                        <div class="action-buttons">
                            <button class="action-btn primary" onclick="createAlert('${ticker}', '${plan.action}')" title="Create price/condition alert">
                                üîî Alert
                            </button>
                            <button class="action-btn" onclick="logToCRM('${ticker}', '${plan.action}', ${finalConfidence}, '${(plan.reason || '').substring(0, 50)}...')" title="Log decision to CRM">
                                üìù Log
                            </button>
                            <button class="action-btn" onclick="exportDecisionMemo('${ticker}', currentAnalysis)" title="Export decision memo">
                                üì§ Export
                            </button>
                        </div>
                    </div>
                    
                    ${triggers.length > 0 ? `
                    <!-- Triggered Conditions Card -->
                    <div class="card" style="border-left: 4px solid ${triggers[0].severity === 'high' ? 'var(--ft-red)' : triggers[0].severity === 'medium' ? '#FFA500' : 'var(--ft-green)'}; margin-bottom: 24px;">
                        <div class="card-header">
                            <div>
                                <div class="card-title">Triggered Conditions</div>
                                <div class="card-subtitle">Rule-Based Signals & Alerts</div>
                            </div>
                        </div>
                        <div style="display: flex; flex-wrap: wrap; gap: 12px;">
                            ${triggers.map(t => `
                                <div class="trigger-badge ${t.severity}" style="padding: 12px 16px; cursor: pointer;" 
                                     onclick="createAlert('${ticker}', '${t.name}')" 
                                     title="Click to create alert for: ${t.description}">
                                    <div style="font-size: 20px;">${t.severity === 'high' ? 'üî¥' : t.severity === 'medium' ? 'üü°' : 'üü¢'}</div>
                                    <div>
                                        <div style="font-weight: 700; margin-bottom: 4px;">${t.name}</div>
                                        <div style="font-size: 11px; opacity: 0.8;">${t.description}</div>
                                    </div>
                                </div>
                            `).join('')}
                        </div>
                    </div>
                    ` : ''}

                    <!-- Key Metrics Bar - Investor Grade -->
                    <div class="key-metrics-bar">
                        <div class="metric-item">
                            <div class="metric-label">Market Cap (Est)</div>
                            <div class="metric-value">$${(market.dollar_adv / 0.02).toFixed(1)}B</div>
                        </div>
                        <div class="metric-item">
                            <div class="metric-label">Avg Volume</div>
                            <div class="metric-value">${(market.dollar_adv / market.price / 1_000_000).toFixed(1)}M</div>
                        </div>
                        <div class="metric-item">
                            <div class="metric-label">Vol Surge</div>
                            <div class="metric-value ${volumeSurge > 1.5 ? 'positive' : 'neutral'}">
                                ${volumeSurge.toFixed(2)}x
                                ${volumeSurge ? `<span class="delta-badge ${volSurgeDeltaFormatted.class}" title="vs 90-day median (${volSurge90dMedian.toFixed(1)}x)">${volSurgeDeltaFormatted.text}</span>` : ''}
                            </div>
                        </div>
                        <div class="metric-item">
                            <div class="metric-label">Intraday Range</div>
                            <div class="metric-value neutral">¬±${surgeData ? surgeData.room_to_run.intraday_potential_pct.toFixed(1) : '0.0'}%</div>
                        </div>
                        <div class="metric-item">
                            <div class="metric-label">Price Position</div>
                            <div class="metric-value neutral">${pricePosition.toFixed(0)}%</div>
                        </div>
                        <div class="metric-item">
                            <div class="metric-label">RSI(14)</div>
                            <div class="metric-value ${market.rsi14 > 70 ? 'negative' : market.rsi14 < 30 ? 'positive' : 'neutral'}">
                                ${market.rsi14?.toFixed(0) || 'N/A'}
                                ${market.rsi14 ? `<span class="delta-badge ${rsiDeltaFormatted.class}" title="vs 90-day median (${rsi90dMedian})">${rsiDeltaFormatted.text}</span>` : ''}
                            </div>
                        </div>
                        <div class="metric-item">
                            <div class="metric-label">Event in</div>
                            <div class="metric-value neutral">${Math.round(catalyst.days_to_event || 0)}d</div>
                        </div>
                        <div class="metric-item">
                            <div class="metric-label">Social Signal</div>
                            <div class="metric-value ${memeSignal ? 'positive' : 'neutral'}">${social.mention_count_total || 0}</div>
                        </div>
                    </div>

                    <!-- Two-Column Layout: Risk/Reward + Quick Insights -->
                    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 16px; margin-bottom: 24px;">
                        <!-- Compact Risk/Reward Panel -->
                        <div class="risk-reward-panel-compact">
                            <div style="font-size: 11px; text-transform: uppercase; color: var(--ft-text-light); margin-bottom: 12px; font-weight: 600;">Risk/Reward</div>
                            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 12px;">
                                <div style="text-align: center;">
                                    <div style="font-size: 10px; color: var(--ft-green); margin-bottom: 4px; font-weight: 600;">Upside</div>
                                    <div style="font-size: 24px; font-weight: 700; color: var(--ft-green); font-family: 'Playfair Display', serif;" id="whatif-upside">${upsidePct !== 'N/A' ? '+' + upsidePct + '%' : 'N/A'}</div>
                                    <div style="font-size: 11px; color: var(--ft-text-light); margin-top: 2px;">$${plan.target_price?.toFixed(2) || 'N/A'}</div>
                                </div>
                                <div style="text-align: center;">
                                    <div style="font-size: 28px; font-weight: 700; color: var(--ft-accent); font-family: 'Playfair Display', serif;" id="whatif-rr">${riskRewardDisplay}</div>
                                    <div style="font-size: 9px; color: var(--ft-text-light); margin-top: 2px;">R/R</div>
                                </div>
                                <div style="text-align: center;">
                                    <div style="font-size: 10px; color: var(--ft-red); margin-bottom: 4px; font-weight: 600;">Downside</div>
                                    <div style="font-size: 24px; font-weight: 700; color: var(--ft-red); font-family: 'Playfair Display', serif;" id="whatif-downside">${downsidePct !== 'N/A' ? downsidePct + '%' : 'N/A'}</div>
                                    <div style="font-size: 11px; color: var(--ft-text-light); margin-top: 2px;">$${plan.stop_price?.toFixed(2) || 'N/A'}</div>
                                </div>
                            </div>
                        </div>
                        
                        <!-- Quick Insight Cards (2 columns) -->
                        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 12px;">
                            <div class="card" style="padding: 16px;">
                                <div style="font-size: 11px; text-transform: uppercase; color: var(--ft-text-light); margin-bottom: 8px; font-weight: 600;">
                                    Pattern Signal
                                </div>
                                <div style="font-size: 20px; font-weight: 700; margin-bottom: 8px;">
                                    ${plan.breakout_flag ? 'üìà Breakout' : pricePosition > 0.7 ? '‚ö†Ô∏è Resistance' : pricePosition < 0.3 ? '‚úÖ Support' : '‚û°Ô∏è Neutral'}
                                </div>
                                <div style="font-size: 12px; color: var(--ft-text-light);">${patternExpectation}</div>
                            </div>
                            <div class="card" style="padding: 16px;">
                                <div style="font-size: 11px; text-transform: uppercase; color: var(--ft-text-light); margin-bottom: 8px; font-weight: 600;">
                                    Catalyst Event
                                </div>
                                <div style="font-size: 20px; font-weight: 700; margin-bottom: 8px;">
                                    ${catalyst.event_type || 'N/A'}
                                </div>
                                <div style="font-size: 12px; color: var(--ft-text-light);">
                                    ${Math.round(catalyst.days_to_event || 0)} days ‚Ä¢ ${expectedMove.toFixed(1)}% expected move
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Alignment Card (Full Width) -->
                    <div class="card" style="padding: 16px; margin-bottom: 24px; border-left: 4px solid ${alignment === 'ALIGNED' ? 'var(--ft-green)' : 'var(--ft-orange)'};">
                        <div style="font-size: 11px; text-transform: uppercase; color: var(--ft-text-light); margin-bottom: 8px; font-weight: 600;">
                            Pattern vs Catalyst Alignment
                        </div>
                        <div style="font-size: 24px; font-weight: 700; margin-bottom: 8px; color: ${alignment === 'ALIGNED' ? 'var(--ft-green)' : 'var(--ft-orange)'};">
                            ${alignment === 'ALIGNED' ? '‚úì Aligned' : '‚ö†Ô∏è Misaligned'}
                        </div>
                        <div style="font-size: 12px; color: var(--ft-text-light);">${alignment === 'ALIGNED' ? 'Technical pattern and catalyst event are aligned for ' + ticker : 'Technical pattern and catalyst event show misalignment for ' + ticker}</div>
                    </div>

                    <!-- What-If Sensitivity Analysis -->
                    <div class="what-if-panel">
                        <div class="card-header" style="margin-bottom: 20px;">
                            <div>
                                <div class="card-title">What-If Analysis</div>
                                <div class="card-subtitle">Stress Test Decision Parameters</div>
                            </div>
                        </div>
                        <div class="slider-group">
                            <div class="slider-label">
                                <span>Stop Loss</span>
                                <span class="slider-value" id="whatif-stop-value">$${plan.stop_price?.toFixed(2) || 'N/A'}</span>
                            </div>
                            <input type="range" class="slider-input" id="whatif-stop" 
                                   min="${market.price ? (market.price * 0.85).toFixed(2) : plan.stop_price * 0.9}" 
                                   max="${market.price ? (market.price * 0.98).toFixed(2) : plan.stop_price * 1.1}" 
                                   step="0.01" 
                                   value="${plan.stop_price || market.price * 0.95}"
                                   oninput="document.getElementById('whatif-stop-value').textContent = '\\$' + parseFloat(this.value).toFixed(2); updateWhatIf();">
                        </div>
                        <div class="slider-group">
                            <div class="slider-label">
                                <span>Target Price</span>
                                <span class="slider-value" id="whatif-target-value">$${plan.target_price?.toFixed(2) || 'N/A'}</span>
                            </div>
                            <input type="range" class="slider-input" id="whatif-target" 
                                   min="${market.price ? (market.price * 1.02).toFixed(2) : plan.target_price * 0.9}" 
                                   max="${market.price ? (market.price * 1.20).toFixed(2) : plan.target_price * 1.2}" 
                                   step="0.01" 
                                   value="${plan.target_price || market.price * 1.10}"
                                   oninput="document.getElementById('whatif-target-value').textContent = '\\$' + parseFloat(this.value).toFixed(2); updateWhatIf();">
                        </div>
                        <div class="slider-group">
                            <div class="slider-label">
                                <span>Expected Move (%)</span>
                                <span class="slider-value" id="whatif-move-value">${expectedMove.toFixed(1)}%</span>
                            </div>
                            <input type="range" class="slider-input" id="whatif-move" 
                                   min="0" max="15" step="0.1" 
                                   value="${expectedMove}"
                                   oninput="document.getElementById('whatif-move-value').textContent = parseFloat(this.value).toFixed(1) + '%'; updateWhatIf();">
                        </div>
                        <div class="slider-group">
                            <div class="slider-label">
                                <span>Days to Event</span>
                                <span class="slider-value" id="whatif-days-value">${Math.round(catalyst.days_to_event || 0)}</span>
                            </div>
                            <input type="range" class="slider-input" id="whatif-days" 
                                   min="0" max="30" step="1" 
                                   value="${Math.round(catalyst.days_to_event || 0)}"
                                   oninput="document.getElementById('whatif-days-value').textContent = parseInt(this.value); updateWhatIf();">
                        </div>
                    </div>

                    <!-- Subscribe to Alerts -->
                    <div class="card" style="margin-bottom: 24px;">
                        <div class="card-header">
                            <div>
                                <div class="card-title">Alert Subscriptions</div>
                                <div class="card-subtitle">Real-time Notifications for Key Signals</div>
                            </div>
                        </div>
                        <div style="display: flex; flex-direction: column; gap: 12px;">
                            <div class="subscribe-toggle" id="subscribe-rsi" onclick="toggleSubscribe('rsi', '${ticker}')">
                                <div class="toggle-switch ${subscribeState.rsi ? 'active' : ''}"></div>
                                <div style="flex: 1;">
                                    <div style="font-weight: 600; font-size: 13px;">RSI Threshold</div>
                                    <div style="font-size: 11px; color: var(--ft-text-light);">Notify when RSI < 30 or > 70</div>
                                </div>
                            </div>
                            <div class="subscribe-toggle" id="subscribe-pricePosition" onclick="toggleSubscribe('pricePosition', '${ticker}')">
                                <div class="toggle-switch ${subscribeState.pricePosition ? 'active' : ''}"></div>
                                <div style="flex: 1;">
                                    <div style="font-weight: 600; font-size: 13px;">Price Position</div>
                                    <div style="font-size: 11px; color: var(--ft-text-light);">Notify when price crosses support/resistance</div>
                                </div>
                            </div>
                            <div class="subscribe-toggle" id="subscribe-socialMentions" onclick="toggleSubscribe('socialMentions', '${ticker}')">
                                <div class="toggle-switch ${subscribeState.socialMentions ? 'active' : ''}"></div>
                                <div style="flex: 1;">
                                    <div style="font-weight: 600; font-size: 13px;">Social Momentum</div>
                                    <div style="font-size: 11px; color: var(--ft-text-light);">Notify when mentions > 50 or sentiment flips</div>
                                </div>
                            </div>
                            <div class="subscribe-toggle" id="subscribe-volumeSurge" onclick="toggleSubscribe('volumeSurge', '${ticker}')">
                                <div class="toggle-switch ${subscribeState.volumeSurge ? 'active' : ''}"></div>
                                <div style="flex: 1;">
                                    <div style="font-weight: 600; font-size: 13px;">Volume Surge</div>
                                    <div style="font-size: 11px; color: var(--ft-text-light);">Notify when volume > 2x average</div>
                                </div>
                            </div>
                            <div class="subscribe-toggle" id="subscribe-eventApproach" onclick="toggleSubscribe('eventApproach', '${ticker}')">
                                <div class="toggle-switch ${subscribeState.eventApproach ? 'active' : ''}"></div>
                                <div style="flex: 1;">
                                    <div style="font-weight: 600; font-size: 13px;">Event Approach</div>
                                    <div style="font-size: 11px; color: var(--ft-text-light);">Notify when event < 3 days away</div>
                                </div>
                            </div>
                        </div>
                    </div>

                    ${memeSignal ? `
                    <div style="background: linear-gradient(135deg, rgba(255,215,0,0.1) 0%, rgba(255,69,0,0.1) 100%); 
                                border-left: 4px solid #FFD700; padding: 16px; border-radius: 8px; margin-bottom: 24px;
                                display: flex; align-items: center; gap: 16px;">
                        <div style="font-size: 32px;">üöÄ</div>
                        <div style="flex: 1;">
                            <div style="font-weight: 700; font-size: 14px; text-transform: uppercase; letter-spacing: 0.5px; margin-bottom: 4px;">
                                Meme/Social Momentum Detected
                            </div>
                            <div style="font-size: 13px; color: var(--ft-text-light);">
                                ${social.mention_count_total || 0} mentions ‚Ä¢ ${((social.sentiment_score || 0) * 100).toFixed(0)}% positive sentiment
                            </div>
                        </div>
                        <div style="text-align: right;">
                            <div style="font-size: 24px; font-weight: 700; color: #FFD700;">HIGH RISK</div>
                        </div>
                    </div>
                    ` : ''}

                    <!-- Technical Pattern Detection -->
                    ${analysis.evidence && analysis.evidence.patterns && analysis.evidence.patterns.primary_pattern ? `
                    <div class="card" style="border-left: 4px solid var(--ft-blue); margin-bottom: 24px;">
                        <div class="card-header">
                            <div>
                                <div class="card-title">üìà Technical Pattern Detected</div>
                                <div class="card-subtitle">Chart Pattern Analysis & Trading Implications</div>
                            </div>
                        </div>
                        <div style="padding: 16px;">
                            ${(() => {
                                const pattern = analysis.evidence.patterns.primary_pattern;
                                const typeColor = pattern.type === 'BULLISH' ? 'var(--ft-green)' : pattern.type === 'BEARISH' ? 'var(--ft-red)' : 'var(--ft-text-light)';
                                return `
                                    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 16px;">
                                        <div>
                                            <div style="font-size: 20px; font-weight: 700; margin-bottom: 8px; color: ${typeColor};">
                                                ${pattern.name || 'Unknown Pattern'}
                                            </div>
                                            <div style="font-size: 12px; color: var(--ft-text-light); margin-bottom: 12px;">
                                                ${pattern.description || 'No description available'}
                                            </div>
                                            <div style="font-size: 13px; font-weight: 600; margin-bottom: 8px;">
                                                Confidence: <span style="color: ${pattern.confidence > 0.7 ? 'var(--ft-green)' : pattern.confidence > 0.5 ? 'var(--ft-orange)' : 'var(--ft-text-light)'};">${(pattern.confidence * 100).toFixed(0)}%</span>
                                            </div>
                                            ${pattern.target ? `
                                                <div style="font-size: 13px; margin-bottom: 4px;">
                                                    <strong>Target:</strong> $${pattern.target.toFixed(2)}
                                                </div>
                                            ` : ''}
                                            ${pattern.stop ? `
                                                <div style="font-size: 13px; margin-bottom: 4px;">
                                                    <strong>Stop:</strong> $${pattern.stop.toFixed(2)}
                                                </div>
                                            ` : ''}
                                        </div>
                                        <div>
                                            ${analysis.evidence.patterns.trading_implications && analysis.evidence.patterns.trading_implications.length > 0 ? `
                                                <div style="font-size: 12px; font-weight: 600; margin-bottom: 8px; text-transform: uppercase; color: var(--ft-text-light);">
                                                    Trading Implications:
                                                </div>
                                                ${analysis.evidence.patterns.trading_implications.map(imp => `
                                                    <div style="font-size: 13px; line-height: 1.6; margin-bottom: 8px; padding: 8px; background: rgba(0,0,0,0.03); border-radius: 4px;">
                                                        ${imp}
                                                    </div>
                                                `).join('')}
                                            ` : ''}
                                        </div>
                                    </div>
                                `;
                            })()}
                        </div>
                    </div>
                    ` : ''}

                    <!-- Evidence & Statistical Analysis - MOVED UP (FT Style) -->
                    ${analysis.evidence ? `
                    <div class="card" style="border-left: 4px solid var(--ft-purple); margin-bottom: 24px;">
                        <div class="card-header">
                            <div>
                                <div class="card-title">Evidence & Statistical Tests</div>
                                <div class="card-subtitle">Rigorous Analysis with Uncertainty Quantification</div>
                            </div>
                        </div>
                        <div class="evidence-panel">
                            ${analysis.evidence.tests && analysis.evidence.tests.length > 0 ? analysis.evidence.tests.slice(0, 3).map((test, idx) => {
                                const badge = test.p_value !== null ? formatSignificanceBadge(test.p_value) : '';
                                const grade = computeEffectGrade(test.p_value, test.effect_size);
                                return `
                                    <div class="evidence-test" style="border-left: 3px solid ${test.decision_implication && test.decision_implication.includes('‚úÖ') ? 'var(--ft-green)' : test.decision_implication && test.decision_implication.includes('‚ùå') ? 'var(--ft-red)' : 'var(--ft-text-light)'}; padding-left: 12px; margin-bottom: 16px;">
                                        <div class="evidence-header">
                                            <span class="evidence-name">${test.name}</span>
                                            <span class="evidence-badge ${grade}">${grade}</span>
                                            ${badge ? `<span class="significance-badge">${badge}</span>` : ''}
                                        </div>
                                        <div class="evidence-hypothesis">${test.hypothesis}</div>
                                        ${test.effect_size !== null ? `
                                            <div class="evidence-effect">
                                                <span class="effect-label">Effect:</span>
                                                <span class="effect-value">${test.effect_size.toFixed(3)}</span>
                                                ${test.ci_low !== null && test.ci_high !== null ? `
                                                    <span class="effect-ci">[${test.ci_low.toFixed(3)}, ${test.ci_high.toFixed(3)}]</span>
                                                ` : ''}
                                            </div>
                                        ` : ''}
                                        ${test.p_value !== null ? `
                                            <div class="evidence-pvalue">
                                                <span class="pvalue-label">p-value:</span>
                                                <span class="pvalue-value ${test.p_value < 0.05 ? 'significant' : ''}">${test.p_value.toFixed(4)}</span>
                                            </div>
                                        ` : ''}
                                        ${test.decision_label ? `
                                            <div class="evidence-decision" style="margin-top: 12px;">
                                                <div style="display: flex; align-items: center; gap: 8px; margin-bottom: 8px;">
                                                    <span class="decision-chip decision-chip-${test.decision_color || 'blue'}" style="
                                                        padding: 4px 12px;
                                                        border-radius: 4px;
                                                        font-size: 12px;
                                                        font-weight: 700;
                                                        text-transform: uppercase;
                                                        background: ${test.decision_color === 'green' ? 'rgba(0,166,81,0.15)' : 
                                                                    test.decision_color === 'red' ? 'rgba(220,20,60,0.15)' : 
                                                                    test.decision_color === 'yellow' ? 'rgba(255,193,7,0.15)' : 
                                                                    'rgba(66,133,244,0.15)'};
                                                        color: ${test.decision_color === 'green' ? 'var(--ft-green)' : 
                                                                test.decision_color === 'red' ? 'var(--ft-red)' : 
                                                                test.decision_color === 'yellow' ? '#FFC107' : 
                                                                'var(--ft-blue)'};
                                                        border: 1px solid ${test.decision_color === 'green' ? 'var(--ft-green)' : 
                                                                        test.decision_color === 'red' ? 'var(--ft-red)' : 
                                                                        test.decision_color === 'yellow' ? '#FFC107' : 
                                                                        'var(--ft-blue)'};
                                                    ">
                                                        ${test.decision_label || 'CONFIRM'}
                                                    </span>
                                                    ${test.decision_severity === 'high' ? '<span style="font-size: 10px; color: var(--ft-red);">‚ö†Ô∏è HIGH</span>' : ''}
                                                </div>
                                                <div style="padding: 10px; background: ${test.decision_color === 'green' ? 'rgba(0,166,81,0.08)' : 
                                                                                            test.decision_color === 'red' ? 'rgba(220,20,60,0.08)' : 
                                                                                            test.decision_color === 'yellow' ? 'rgba(255,193,7,0.08)' : 
                                                                                            'rgba(66,133,244,0.08)'}; border-radius: 4px; font-size: 13px; line-height: 1.5; color: var(--ft-text);">
                                                    ${test.decision_implication || 'No decision rationale available.'}
                                                </div>
                                            </div>
                                        ` : test.decision_implication ? `
                                            <div class="evidence-decision" style="margin-top: 12px; padding: 12px; background: rgba(128,128,128,0.1); border-radius: 4px; font-size: 13px; line-height: 1.5;">
                                                <strong>üìä TRADING DECISION:</strong>
                                                <div style="margin-top: 6px; color: var(--ft-text);">
                                                    ${test.decision_implication}
                                                </div>
                                            </div>
                                        ` : ''}
                                    </div>
                                `;
                            }).join('') : '<div style="padding: 20px; text-align: center; color: var(--ft-text-light);">No statistical tests available</div>'}
                            
                            ${analysis.evidence && analysis.evidence.multiple_testing && analysis.evidence.multiple_testing.q_values && analysis.evidence.multiple_testing.q_values.length > 0 ? `
                                <div style="margin-top: 16px; padding: 12px; background: rgba(0,0,0,0.03); border-radius: 4px;">
                                    <div style="font-size: 12px; font-weight: 600; margin-bottom: 8px; text-transform: uppercase; color: var(--ft-text-light);">
                                        FDR Correction (Multiple Testing)
                                    </div>
                                    ${analysis.evidence.multiple_testing.q_values.map(qv => `
                                        <div style="display: flex; align-items: center; gap: 8px; margin-bottom: 4px;">
                                            <span style="font-size: 11px;">${qv.test}:</span>
                                            <span class="fdr-badge fdr-badge-${qv.badge_color || 'red'}" style="
                                                padding: 2px 8px;
                                                border-radius: 3px;
                                                font-size: 10px;
                                                font-weight: 600;
                                                background: ${qv.badge_color === 'green' ? 'rgba(0,166,81,0.15)' : 
                                                            qv.badge_color === 'yellow' ? 'rgba(255,193,7,0.15)' : 
                                                            'rgba(220,20,60,0.15)'};
                                                color: ${qv.badge_color === 'green' ? 'var(--ft-green)' : 
                                                        qv.badge_color === 'yellow' ? '#FFC107' : 
                                                        'var(--ft-red)'};
                                            ">
                                                ${qv.badge || `q=${qv.q.toFixed(3)}`}
                                            </span>
                                        </div>
                                    `).join('')}
                                </div>
                            ` : ''}
                            
                            ${analysis.evidence && analysis.evidence.calibration ? `
                                <div class="calibration-metrics">
                                    <div class="calibration-item">
                                        <span class="calibration-label">ECE:</span>
                                        <span class="calibration-value">${(analysis.evidence.calibration.ece || 0).toFixed(3)}</span>
                                    </div>
                                    <div class="calibration-item">
                                        <span class="calibration-label">Brier:</span>
                                        <span class="calibration-value">${(analysis.evidence.calibration.brier || 0).toFixed(3)}</span>
                                    </div>
                                    <div class="calibration-item">
                                        <span class="calibration-label">Samples:</span>
                                        <span class="calibration-value">${analysis.evidence.calibration.n_samples || 0}</span>
                                    </div>
                                    <div class="calibration-item">
                                        <span class="calibration-label">Confidence:</span>
                                        <span class="calibration-value">${(analysis.evidence.calibration.calibrated_confidence * 100 || 50).toFixed(1)}%</span>
                                    </div>
                                </div>
                            ` : ''}
                        </div>
                    </div>
                    ` : ''}


                <!-- Main Analytics Grid -->
                <div class="analytics-grid">
                    <div class="analytics-main">
                        <!-- Price Chart with Indicators -->
                        <div class="card">
                            <div class="card-header">
                                <div>
                                    <div class="card-title">Price Action & Technical Indicators</div>
                                    <div class="card-subtitle">30-Day Time Series with Moving Averages & Support/Resistance</div>
                                </div>
                            </div>
                            <div id="price-chart" class="chart-container"></div>
                            <div class="indicator-explanation">
                                <h4>Technical Indicators Explained:</h4>
                                <p><strong>SMA 20:</strong> 20-day Simple Moving Average - Short-term trend direction. Price above = bullish, below = bearish.</p>
                                <p><strong>SMA 50:</strong> 50-day Simple Moving Average - Medium-term trend. Golden cross (SMA20 > SMA50) = bullish signal.</p>
                                <p><strong>Support:</strong> Recent 10-day low - Price level where buying interest may emerge.</p>
                                <p><strong>Resistance:</strong> Recent 10-day high - Price level where selling pressure may occur.</p>
                            </div>
                        </div>

                        <!-- RSI Chart -->
                        <div class="card">
                            <div class="card-header">
                                <div>
                                    <div class="card-title">RSI(14) Momentum Indicator</div>
                                    <div class="card-subtitle">Relative Strength Index - Overbought/Oversold Conditions</div>
                                </div>
                            </div>
                            <div id="rsi-chart" class="chart-container"></div>
                            <div class="indicator-explanation">
                                <h4>RSI Explained:</h4>
                                <p><strong>RSI > 70:</strong> Overbought - Stock may be due for a pullback. Consider selling or tightening stops.</p>
                                <p><strong>RSI < 30:</strong> Oversold - Stock may be due for a bounce. Potential buying opportunity.</p>
                                <p><strong>RSI 30-70:</strong> Neutral range - No extreme conditions. Price action driven by other factors.</p>
                                <p><strong>Current RSI:</strong> ${market.rsi14?.toFixed(1) || 'N/A'} - ${market.rsi14 > 70 ? '‚ö†Ô∏è Overbought' : market.rsi14 < 30 ? '‚úÖ Oversold' : 'Neutral'}</p>
                            </div>
                        </div>

                        <!-- Trade Plan -->
                        <div class="card">
                            <div class="card-header">
                                <div>
                                    <div class="card-title">Trade Execution Plan</div>
                                    <div class="card-subtitle">Entry, Stop, Target & Risk Parameters</div>
                                </div>
                            </div>
                            <div class="trade-plan-grid">
                                <div class="trade-metric">
                                    <div class="trade-metric-label">Entry Price</div>
                                    <div class="trade-metric-value">$${plan.entry_price?.toFixed(2) || 'N/A'}</div>
                                </div>
                                <div class="trade-metric">
                                    <div class="trade-metric-label">Stop Loss</div>
                                    <div class="trade-metric-value" style="color: var(--ft-red);">$${plan.stop_price?.toFixed(2) || 'N/A'}</div>
                                </div>
                                <div class="trade-metric">
                                    <div class="trade-metric-label">Target Price</div>
                                    <div class="trade-metric-value" style="color: var(--ft-green);">$${plan.target_price?.toFixed(2) || 'N/A'}</div>
                                </div>
                                <div class="trade-metric">
                                    <div class="trade-metric-label">Timeout</div>
                                    <div class="trade-metric-value">${plan.timeout_days || 5} days</div>
                                </div>
                            </div>
                        </div>

                        <!-- AI Reasoning -->
                        <div class="reasoning-section">
                            <div class="card-title" style="margin-bottom: 16px;">AI Trader Analysis</div>
                            <div class="reasoning-text">${plan.reason || 'No reasoning provided by the AI for ' + ticker + '.'}</div>
                        </div>

                        <!-- Strategy Rationale -->
                        <div class="strategy-card">
                            <div class="strategy-arm">${strategy.selected_arm || 'N/A'}</div>
                            <div class="strategy-reason">${strategy.reason || 'No strategy rationale available for ' + ticker + '.'}</div>
                            <div class="gating-facts">
                                ${(strategy.gating_facts || []).map(fact => `<div class="gating-fact">${fact}</div>`).join('')}
                            </div>
                        </div>
                    </div>

                    <div class="analytics-sidebar">
                        <!-- Catalyst Timeline -->
                        <div class="catalyst-card">
                            <div class="catalyst-header">
                                <div class="catalyst-type">${catalyst.event_type || 'N/A'}</div>
                                <div>
                                    <div class="catalyst-days">${Math.round(catalyst.days_to_event || 0)}</div>
                                    <div style="font-size: 11px; text-transform: uppercase; opacity: 0.8;">Days</div>
                                </div>
                            </div>
                            <div style="display: grid; grid-template-columns: repeat(3, 1fr); gap: 12px; margin-top: 16px;">
                                <div style="text-align: center; padding: 12px; background: white; border-radius: 4px;">
                                    <div style="font-size: 10px; text-transform: uppercase; color: var(--ft-text-light); margin-bottom: 4px;">Expected Move</div>
                                    <div style="font-size: 18px; font-weight: 700;">${expectedMove.toFixed(1)}%</div>
                                </div>
                                <div style="text-align: center; padding: 12px; background: white; border-radius: 4px;">
                                    <div style="font-size: 10px; text-transform: uppercase; color: var(--ft-text-light); margin-bottom: 4px;">Materiality</div>
                                    <div style="font-size: 18px; font-weight: 700;">${materiality.toFixed(0)}%</div>
                                </div>
                                <div style="text-align: center; padding: 12px; background: white; border-radius: 4px;">
                                    <div style="font-size: 10px; text-transform: uppercase; color: var(--ft-text-light); margin-bottom: 4px;">Rank</div>
                                    <div style="font-size: 18px; font-weight: 700;">${Math.round(catalyst.rank || 0)}</div>
                                </div>
                            </div>
                        </div>

                        <!-- Market Context -->
                        <div class="card">
                            <div class="card-header">
                                <div>
                                    <div class="card-title">Market Context</div>
                                    <div class="card-subtitle">Technical Indicators</div>
                                </div>
                            </div>
                            <div class="perf-grid">
                                <div class="perf-stat">
                                    <div class="perf-label">RSI(14)</div>
                                    <div class="perf-value" style="color: ${market.rsi14 > 70 ? 'var(--ft-red)' : market.rsi14 < 30 ? 'var(--ft-green)' : 'var(--ft-primary)'};">
                                        ${market.rsi14?.toFixed(1) || 'N/A'}
                                    </div>
                                </div>
                                <div class="perf-stat">
                                    <div class="perf-label">ATR(14)</div>
                                    <div class="perf-value">$${market.atr14?.toFixed(2) || 'N/A'}</div>
                                </div>
                                <div class="perf-stat">
                                    <div class="perf-label">Spread</div>
                                    <div class="perf-value">$${market.spread?.toFixed(4) || 'N/A'}</div>
                                </div>
                                <div class="perf-stat">
                                    <div class="perf-label">Volatility</div>
                                    <div class="perf-value">${(plan.rolling_volatility_10d * 100 || 0).toFixed(2)}%</div>
                                </div>
                            </div>
                        </div>

                        <!-- Social Sentiment -->
                        <div class="card">
                            <div class="card-header">
                                <div>
                                    <div class="card-title">Social Sentiment</div>
                                    <div class="card-subtitle">StockTwits Momentum</div>
                                </div>
                            </div>
                            <div class="volume-metrics">
                                <div class="volume-metric">
                                    <div class="volume-label">Mentions</div>
                                    <div class="volume-value">${social.mention_count_total || 0}</div>
                                </div>
                                <div class="volume-metric">
                                    <div class="volume-label">Sentiment Score</div>
                                    <div class="volume-value" style="color: ${(social.sentiment_score || 0) > 0 ? 'var(--ft-green)' : 'var(--ft-red)'};">
                                        ${((social.sentiment_score || 0) * 100).toFixed(1)}%
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- Performance History -->
                        <div class="card">
                            <div class="card-header">
                                <div>
                                    <div class="card-title">Historical Performance</div>
                                    <div class="card-subtitle">Backtest Statistics</div>
                                </div>
                            </div>
                            <div class="perf-grid">
                                <div class="perf-stat">
                                    <div class="perf-label">Hit Rate</div>
                                    <div class="perf-value" style="color: ${(history.hit_rate || 0) > 0.5 ? 'var(--ft-green)' : 'var(--ft-red)'};">
                                        ${((history.hit_rate || 0) * 100).toFixed(1)}%
                                    </div>
                                </div>
                                <div class="perf-stat">
                                    <div class="perf-label">Samples</div>
                                    <div class="perf-value">${history.samples || 0}</div>
                                </div>
                                <div class="perf-stat">
                                    <div class="perf-label">Avg Win</div>
                                    <div class="perf-value" style="color: var(--ft-green);">
                                        ${((history.avg_win || 0) * 100).toFixed(2)}%
                                    </div>
                                </div>
                                <div class="perf-stat">
                                    <div class="perf-label">Avg Loss</div>
                                    <div class="perf-value" style="color: var(--ft-red);">
                                        ${((history.avg_loss || 0) * 100).toFixed(2)}%
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- Recent News -->
                        <div class="card">
                            <div class="card-header">
                                <div>
                                    <div class="card-title">Recent News</div>
                                    <div class="card-subtitle">Market Activity & Sentiment</div>
                                </div>
                            </div>
                            <div class="news-list">
                                ${news.length > 0 ? news.slice(0, 5).map(item => `
                                    <div class="news-item">
                                        <div class="news-headline">${item.headline || 'No headline'}</div>
                                        <div class="news-meta">
                                            <span>${new Date(item.timestamp).toLocaleDateString()}</span>
                                            <span class="sentiment-badge ${item.sentiment > 0 ? 'positive' : item.sentiment < 0 ? 'negative' : 'neutral'}">
                                                ${item.sentiment > 0 ? 'Positive' : item.sentiment < 0 ? 'Negative' : 'Neutral'}
                                            </span>
                                        </div>
                                    </div>
                                `).join('') : '<div style="text-align: center; padding: 20px; color: var(--ft-text-light);">No recent news available for ' + ticker + '</div>'}
                            </div>
                        </div>

                    </div>
                </div>
            `;

            // Debug: Log evidence data structure
            console.log('Evidence data structure:', {
                hasEvidence: !!analysis.evidence,
                evidenceKeys: analysis.evidence ? Object.keys(analysis.evidence) : [],
                tests: analysis.evidence?.tests?.length || 0,
                calibration: analysis.evidence?.calibration || null
            });
            
            // Render charts after DOM is updated - use requestAnimationFrame for better timing
            if (historyData && historyData.data && historyData.data.length > 0) {
                // Wait for DOM to be fully rendered
                requestAnimationFrame(() => {
                    setTimeout(() => {
                        console.log('Rendering charts with data:', {
                            ticker: historyData.ticker,
                            dataPoints: historyData.data.length,
                            hasIndicators: !!historyData.indicators,
                            sampleDate: historyData.data[0]?.date,
                            sampleClose: historyData.data[0]?.close
                        });
                        
                        // Verify chart containers exist
                        const priceChartEl = document.getElementById('price-chart');
                        const rsiChartEl = document.getElementById('rsi-chart');
                        
                        if (!priceChartEl || !rsiChartEl) {
                            console.error('‚ùå Chart containers not found in DOM');
                            return;
                        }
                        
                        // Ensure containers have dimensions
                        if (priceChartEl.offsetHeight === 0) {
                            priceChartEl.style.height = '450px';
                        }
                        if (rsiChartEl.offsetHeight === 0) {
                            rsiChartEl.style.height = '450px';
                        }
                        
                        try {
                            renderPriceChart(historyData);
                            renderRSIChart(historyData);
                            console.log('‚úÖ Charts rendered successfully');
                        } catch (chartError) {
                            console.error('‚ùå Chart rendering error:', chartError);
                            console.error('Stack trace:', chartError.stack);
                        }
                    }, 300); // Reduced delay but still enough for DOM
                });
            } else {
                console.warn('‚ö†Ô∏è No history data available for charts:', {
                    hasHistoryData: !!historyData,
                    hasData: !!historyData?.data,
                    dataLength: historyData?.data?.length || 0
                });
            }
        }

        function formatSignificanceBadge(pValue) {
            if (pValue === null) return '';
            if (pValue < 0.001) return '***';
            if (pValue < 0.01) return '**';
            if (pValue < 0.05) return '*';
            return 'ns';
        }

        function computeEffectGrade(pValue, effectSize) {
            if (pValue === null || effectSize === null) return 'C';
            if (pValue < 0.01 && Math.abs(effectSize) > 0.3) return 'A';
            if (pValue < 0.05 && Math.abs(effectSize) > 0.1) return 'B';
            return 'C';
        }

        // Rule Engine: Evaluate triggered conditions
        function evaluateTriggeredConditions(metrics) {
            const triggers = [];
            
            // Rule 1: Opportunistic Entry (RSI<30 AND VolSurge‚â•1.8x AND Event<7d)
            if (metrics.rsi < 30 && metrics.volumeSurge >= 1.8 && metrics.daysToEvent < 7) {
                triggers.push({
                    name: 'Opportunistic Entry',
                    severity: 'high',
                    description: 'RSI<30 + Volume Surge 1.8x+ + Event <7 days'
                });
            }
            
            // Rule 2: Overbought Warning (RSI>70 AND Price Position>80%)
            if (metrics.rsi > 70 && metrics.pricePosition > 80) {
                triggers.push({
                    name: 'Overbought Warning',
                    severity: 'high',
                    description: 'RSI>70 + Price near resistance'
                });
            }
            
            // Rule 3: Catalyst Approaching (Event<3 days AND Expected Move>5%)
            if (metrics.daysToEvent < 3 && metrics.expectedMove > 5) {
                triggers.push({
                    name: 'Catalyst Approaching',
                    severity: 'high',
                    description: 'High-impact event <3 days'
                });
            }
            
            // Rule 4: Volume Surge Signal (Vol Surge>2x AND Social Mentions>50)
            if (metrics.volumeSurge > 2.0 && metrics.socialMentions > 50) {
                triggers.push({
                    name: 'Momentum Surge',
                    severity: 'medium',
                    description: 'Volume surge + Social momentum'
                });
            }
            
            // Rule 5: Support Bounce Setup (Price Position<30% AND RSI<40)
            if (metrics.pricePosition < 30 && metrics.rsi < 40) {
                triggers.push({
                    name: 'Support Bounce Setup',
                    severity: 'medium',
                    description: 'Near support + Oversold'
                });
            }
            
            // Rule 6: Low Confidence Alert (Confidence<50%)
            if (metrics.confidence < 0.5) {
                triggers.push({
                    name: 'Low Confidence',
                    severity: 'low',
                    description: 'AI confidence below 50%'
                });
            }
            
            return triggers;
        }

        // Safe Risk/Reward calculation with guardrails
        function safeRiskRewardRatio(targetPrice, currentPrice, stopPrice) {
            if (!targetPrice || !currentPrice || !stopPrice) return null;
            if (targetPrice <= currentPrice || stopPrice >= currentPrice) return null;
            const upside = targetPrice - currentPrice;
            const downside = currentPrice - stopPrice;
            if (downside <= 0) return null;
            return Math.abs(upside / downside);
        }

        // Action Handlers
        async function createAlert(ticker, condition) {
            try {
                const response = await fetch(`${API_BASE}/alerts`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ ticker, condition, timestamp: new Date().toISOString() })
                });
                if (response.ok) {
                    alert(`‚úÖ Alert created for ${ticker}: ${condition}`);
                } else {
                    alert(`‚ö†Ô∏è Alert creation failed (stub endpoint)`);
                }
            } catch (e) {
                alert(`‚ö†Ô∏è Alert creation failed: ${e.message}`);
            }
        }

        async function logToCRM(ticker, verdict, confidence, rationale) {
            try {
                const response = await fetch(`${API_BASE}/crm/log`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ ticker, verdict, confidence, rationale, timestamp: new Date().toISOString() })
                });
                if (response.ok) {
                    alert(`‚úÖ Decision logged to CRM for ${ticker}`);
                } else {
                    alert(`‚ö†Ô∏è CRM logging failed (stub endpoint)`);
                }
            } catch (e) {
                alert(`‚ö†Ô∏è CRM logging failed: ${e.message}`);
            }
        }

        function exportDecisionMemo(ticker, analysis) {
            const memo = {
                ticker,
                timestamp: new Date().toISOString(),
                verdict: analysis.plan?.action,
                confidence: analysis.plan?.confidence,
                rationale: analysis.plan?.reason,
                evidence: analysis.evidence,
                plan: analysis.plan
            };
            const blob = new Blob([JSON.stringify(memo, null, 2)], { type: 'application/json' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `decision_memo_${ticker}_${new Date().toISOString().split('T')[0]}.json`;
            a.click();
            URL.revokeObjectURL(url);
        }

        // Global what-if update function
        window.updateWhatIf = function() {
            const stopInput = document.getElementById('whatif-stop');
            const targetInput = document.getElementById('whatif-target');
            const moveInput = document.getElementById('whatif-move');
            const daysInput = document.getElementById('whatif-days');
            
            if (!stopInput || !targetInput || !currentAnalysis) return;
            
            const marketPrice = currentAnalysis.analysis?.market?.price || currentAnalysis.plan?.entry_price;
            if (!marketPrice) return;
            
            const stopPrice = parseFloat(stopInput.value);
            const targetPrice = parseFloat(targetInput.value);
            
            // Recalculate risk/reward
            const newRR = safeRiskRewardRatio(targetPrice, marketPrice, stopPrice);
            const newUpside = ((targetPrice - marketPrice) / marketPrice * 100).toFixed(1);
            const newDownside = ((stopPrice - marketPrice) / marketPrice * 100).toFixed(1);
            
            // Update display
            const rrDisplay = document.getElementById('whatif-rr');
            const upsideDisplay = document.getElementById('whatif-upside');
            const downsideDisplay = document.getElementById('whatif-downside');
            
            if (rrDisplay) rrDisplay.textContent = newRR ? newRR.toFixed(1) + ':1' : 'N/A';
            if (upsideDisplay) upsideDisplay.textContent = '+' + newUpside + '%';
            if (downsideDisplay) downsideDisplay.textContent = newDownside + '%';
        };

        // Global subscribe toggle handler
        window.toggleSubscribe = function(signal, ticker) {
            const toggle = document.getElementById(`subscribe-${signal}`);
            if (!toggle) return;
            
            const switchEl = toggle.querySelector('.toggle-switch');
            if (!switchEl) return;
            
            const isActive = switchEl.classList.contains('active');
            
            // Toggle state
            switchEl.classList.toggle('active', !isActive);
            toggle.classList.toggle('active', !isActive);
            
            // Create/remove subscription
            if (!isActive) {
                createAlert(ticker, signal);
            }
        };

        async function analyzeStock(ticker) {
            if (!ticker) {
                const input = document.getElementById('ticker-input');
                ticker = input.value.trim().toUpperCase();
            }
            if (!ticker) return;

            debugLog(`Starting analysis for ${ticker}`, 'info');
            const content = document.getElementById('dashboard-content');
            content.innerHTML = '<div class="loading"><div class="spinner"></div></div>';

            try {
                debugLog(`Fetching /analyze/${ticker}...`, 'info');
                const response = await fetch(`${API_BASE}/analyze/${ticker}`);
                
                if (!response.ok) {
                    debugLog(`‚ùå /analyze/${ticker} failed: ${response.status} ${response.statusText}`, 'error');
                    throw new Error(`Analysis failed: ${response.statusText}`);
                }
                
                debugLog(`‚úÖ /analyze/${ticker} succeeded`, 'success');
                const data = await response.json();
                currentAnalysis = data;
                await renderAnalysis(data);

            } catch (error) {
                debugLog(`‚ùå Analysis error: ${error.message}`, 'error');
                content.innerHTML = `
                    <div class="empty-state">
                        <div class="empty-state-icon">‚ö†Ô∏è</div>
                        <div class="empty-state-title">Analysis Error</div>
                        <div class="empty-state-text">${error.message}</div>
                    </div>
                `;
            }
        }

        async function fetchScanList() {
            try {
                const response = await fetch(`${API_BASE}/scan`);
                const data = await response.json();
                console.log('Opportunities loaded:', data.length);
            } catch (error) {
                console.error('Failed to fetch opportunities:', error);
            }
        }

        fetchScanList();
    </script>
</body>
</html>
