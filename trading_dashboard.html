<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Enterprise Trading Analytics | Catalyst Radar</title>
    <script src="https://cdn.plot.ly/plotly-2.26.0.min.js"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Playfair+Display:wght@400;700&family=Inter:wght@300;400;500;600;700&display=swap');
        
        :root {
            --ft-primary: #000000;
            --ft-secondary: #1a1a1a;
            --ft-accent: #0050B3;
            --ft-text: #2E2E2E;
            --ft-text-light: #6B6B6B;
            --ft-bg: #FFFFFF;
            --ft-surface: #FAFAFA;
            --ft-border: #E5E5E5;
            --ft-green: #00A651;
            --ft-red: #DC143C;
            --ft-orange: #FF6B35;
            --ft-yellow: #FFC107;
            --ft-blue: #0050B3;
            --ft-purple: #6B46C1;
            --shadow-sm: 0 1px 3px rgba(0,0,0,0.08);
            --shadow-md: 0 4px 12px rgba(0,0,0,0.1);
            --shadow-lg: 0 8px 24px rgba(0,0,0,0.12);
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Inter', -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
            background: var(--ft-bg);
            color: var(--ft-text);
            line-height: 1.6;
            overflow-x: hidden;
        }

        .header {
            background: var(--ft-primary);
            color: white;
            padding: 16px 32px;
            border-bottom: 3px solid var(--ft-accent);
            display: flex;
            justify-content: space-between;
            align-items: center;
            position: sticky;
            top: 0;
            z-index: 100;
            box-shadow: var(--shadow-md);
        }

        .header h1 {
            font-family: 'Playfair Display', serif;
            font-size: 24px;
            font-weight: 700;
            letter-spacing: -0.5px;
        }

        .header-meta {
            display: flex;
            gap: 24px;
            font-size: 13px;
            font-weight: 500;
            opacity: 0.9;
        }

        .container {
            max-width: 1800px;
            margin: 0 auto;
            padding: 32px;
        }

        .top-bar {
            display: grid;
            grid-template-columns: 1fr auto;
            gap: 24px;
            margin-bottom: 32px;
            align-items: center;
        }

        .search-group {
            display: flex;
            gap: 12px;
            align-items: center;
        }

        .search-input {
            flex: 1;
            padding: 14px 20px;
            border: 2px solid var(--ft-border);
            border-radius: 4px;
            font-size: 16px;
            font-family: 'Inter', sans-serif;
            transition: border-color 0.2s;
        }

        .search-input:focus {
            outline: none;
            border-color: var(--ft-accent);
        }

        .btn-primary {
            padding: 14px 32px;
            background: var(--ft-accent);
            color: white;
            border: none;
            border-radius: 4px;
            font-size: 14px;
            font-weight: 600;
            cursor: pointer;
            transition: background 0.2s;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .btn-primary:hover {
            background: #003d8a;
        }

        .btn-secondary {
            padding: 14px 24px;
            background: transparent;
            color: var(--ft-text);
            border: 2px solid var(--ft-border);
            border-radius: 4px;
            font-size: 14px;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.2s;
        }

        .btn-secondary:hover {
            border-color: var(--ft-accent);
            color: var(--ft-accent);
        }

        .decision-bar {
            background: linear-gradient(135deg, #1a1a1a 0%, #2d2d2d 100%);
            color: white;
            padding: 24px 32px;
            border-radius: 8px;
            margin-bottom: 32px;
            display: grid;
            grid-template-columns: auto 1fr auto auto;
            gap: 32px;
            align-items: center;
            box-shadow: var(--shadow-lg);
        }

        .verdict-badge {
            font-family: 'Playfair Display', serif;
            font-size: 48px;
            font-weight: 700;
            text-transform: uppercase;
            letter-spacing: 2px;
        }

        .verdict-badge.BUY { color: var(--ft-green); }
        .verdict-badge.SELL { color: var(--ft-red); }
        .verdict-badge.SKIP { color: var(--ft-yellow); }

        .ticker-display {
            font-size: 32px;
            font-weight: 700;
            letter-spacing: -1px;
        }

        .confidence-meter {
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 8px;
        }

        .confidence-value {
            font-size: 36px;
            font-weight: 700;
            font-family: 'Playfair Display', serif;
        }

        .confidence-label {
            font-size: 11px;
            text-transform: uppercase;
            letter-spacing: 1px;
            opacity: 0.8;
        }

        .confidence-bar {
            width: 120px;
            height: 8px;
            background: rgba(255,255,255,0.2);
            border-radius: 4px;
            overflow: hidden;
            margin-top: 8px;
        }

        .confidence-fill {
            height: 100%;
            background: var(--ft-green);
            transition: width 0.5s;
        }

        .analytics-grid {
            display: grid;
            grid-template-columns: 2fr 1fr;
            gap: 24px;
            margin-bottom: 24px;
        }

        .analytics-main {
            display: flex;
            flex-direction: column;
            gap: 24px;
        }

        .analytics-sidebar {
            display: flex;
            flex-direction: column;
            gap: 24px;
        }

        .card {
            background: white;
            border: 1px solid var(--ft-border);
            border-radius: 8px;
            padding: 24px;
            box-shadow: var(--shadow-sm);
            transition: box-shadow 0.2s;
        }

        .card:hover {
            box-shadow: var(--shadow-md);
        }

        .card-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
            padding-bottom: 16px;
            border-bottom: 2px solid var(--ft-border);
        }

        .card-title {
            font-family: 'Playfair Display', serif;
            font-size: 20px;
            font-weight: 700;
            color: var(--ft-primary);
            letter-spacing: -0.3px;
        }

        .card-subtitle {
            font-size: 13px;
            color: var(--ft-text-light);
            text-transform: uppercase;
            letter-spacing: 0.5px;
            margin-top: 4px;
        }

        /* Surge Analysis Card */
        .surge-analysis {
            background: linear-gradient(135deg, rgba(0,166,81,0.1) 0%, rgba(0,80,179,0.1) 100%);
            border-left: 4px solid var(--ft-green);
            padding: 24px;
            border-radius: 8px;
        }

        .surge-score {
            font-size: 64px;
            font-weight: 700;
            font-family: 'Playfair Display', serif;
            text-align: center;
            margin: 20px 0;
        }

        .surge-score.high { color: var(--ft-green); }
        .surge-score.moderate { color: var(--ft-orange); }
        .surge-score.low { color: var(--ft-text-light); }

        .room-to-run {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 16px;
            margin-top: 20px;
        }

        .room-metric {
            padding: 16px;
            background: white;
            border-radius: 6px;
            text-align: center;
        }

        .room-label {
            font-size: 12px;
            color: var(--ft-text-light);
            margin-bottom: 8px;
        }

        .room-value {
            font-size: 24px;
            font-weight: 700;
            font-family: 'Playfair Display', serif;
        }

        /* Pattern vs Catalyst Comparison */
        .comparison-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px;
            margin-top: 20px;
        }

        .comparison-panel {
            padding: 20px;
            background: var(--ft-surface);
            border-radius: 6px;
            border-left: 4px solid var(--ft-accent);
        }

        .comparison-title {
            font-size: 14px;
            font-weight: 600;
            text-transform: uppercase;
            margin-bottom: 12px;
            color: var(--ft-accent);
        }

        .comparison-item {
            display: flex;
            justify-content: space-between;
            padding: 8px 0;
            border-bottom: 1px solid var(--ft-border);
        }

        .comparison-label {
            font-size: 13px;
            color: var(--ft-text-light);
        }

        .comparison-value {
            font-size: 14px;
            font-weight: 600;
        }

        /* Meme Signal Indicator */
        .meme-signal {
            background: linear-gradient(135deg, rgba(255,107,53,0.2) 0%, rgba(255,193,7,0.2) 100%);
            border: 2px solid var(--ft-orange);
            padding: 20px;
            border-radius: 8px;
            text-align: center;
        }

        .meme-signal.active {
            background: linear-gradient(135deg, rgba(255,107,53,0.3) 0%, rgba(255,193,7,0.3) 100%);
            border-color: var(--ft-red);
        }

        .meme-icon {
            font-size: 48px;
            margin-bottom: 12px;
        }

        .meme-text {
            font-size: 18px;
            font-weight: 700;
            color: var(--ft-orange);
        }

        .meme-signal.active .meme-text {
            color: var(--ft-red);
        }

        /* Chart Container */
        .chart-container {
            height: 400px;
            width: 100%;
            margin-top: 16px;
            background: white;
            border-radius: 6px;
            min-height: 400px;
            position: relative;
        }
        
        .chart-container svg {
            width: 100% !important;
            height: 100% !important;
        }

        .indicator-explanation {
            margin-top: 16px;
            padding: 16px;
            background: var(--ft-surface);
            border-radius: 6px;
            font-size: 13px;
            line-height: 1.6;
        }

        .indicator-explanation h4 {
            font-size: 14px;
            font-weight: 600;
            margin-bottom: 8px;
            color: var(--ft-primary);
        }

        .trade-plan-grid {
            display: grid;
            grid-template-columns: repeat(4, 1fr);
            gap: 20px;
        }

        .trade-metric {
            text-align: center;
            padding: 16px;
            background: var(--ft-surface);
            border-radius: 6px;
        }

        .trade-metric-label {
            font-size: 11px;
            text-transform: uppercase;
            letter-spacing: 1px;
            color: var(--ft-text-light);
            margin-bottom: 8px;
        }

        .trade-metric-value {
            font-size: 24px;
            font-weight: 700;
            color: var(--ft-primary);
            font-family: 'Playfair Display', serif;
        }

        .pattern-analysis {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px;
        }

        .pattern-item {
            padding: 16px;
            background: var(--ft-surface);
            border-radius: 6px;
        }

        .pattern-label {
            font-size: 12px;
            color: var(--ft-text-light);
            margin-bottom: 8px;
        }

        .pattern-value {
            font-size: 20px;
            font-weight: 600;
        }

        .price-position-bar {
            width: 100%;
            height: 12px;
            background: var(--ft-border);
            border-radius: 6px;
            overflow: hidden;
            margin-top: 12px;
            position: relative;
        }

        .price-position-fill {
            height: 100%;
            background: linear-gradient(90deg, var(--ft-red) 0%, var(--ft-yellow) 50%, var(--ft-green) 100%);
            transition: width 0.5s;
        }

        .price-position-marker {
            position: absolute;
            top: 0;
            width: 3px;
            height: 100%;
            background: var(--ft-primary);
            transform: translateX(-50%);
        }

        .volume-metrics {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 16px;
        }

        .volume-metric {
            padding: 16px;
            background: var(--ft-surface);
            border-radius: 6px;
        }

        .volume-label {
            font-size: 12px;
            color: var(--ft-text-light);
            margin-bottom: 8px;
        }

        .volume-value {
            font-size: 22px;
            font-weight: 700;
        }

        .surge-badge {
            display: inline-block;
            padding: 4px 12px;
            border-radius: 12px;
            font-size: 11px;
            font-weight: 600;
            margin-left: 8px;
        }

        .surge-badge.high {
            background: var(--ft-green);
            color: white;
        }

        .surge-badge.medium {
            background: var(--ft-yellow);
            color: var(--ft-primary);
        }

        .surge-badge.low {
            background: var(--ft-red);
            color: white;
        }

        .catalyst-card {
            background: linear-gradient(135deg, rgba(0,80,179,0.1) 0%, rgba(107,70,193,0.1) 100%);
            border-left: 4px solid var(--ft-accent);
            padding: 20px;
            border-radius: 6px;
        }

        .catalyst-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 16px;
        }

        .catalyst-type {
            font-size: 14px;
            font-weight: 600;
            text-transform: uppercase;
            color: var(--ft-accent);
        }

        .catalyst-days {
            font-size: 32px;
            font-weight: 700;
            font-family: 'Playfair Display', serif;
            color: var(--ft-primary);
        }

        .reasoning-section {
            background: var(--ft-surface);
            padding: 24px;
            border-radius: 8px;
            border-left: 4px solid var(--ft-accent);
        }

        .reasoning-text {
            font-size: 15px;
            line-height: 1.8;
            color: var(--ft-text);
            font-style: italic;
        }

        .perf-grid {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 16px;
        }

        .perf-stat {
            padding: 16px;
            background: var(--ft-surface);
            border-radius: 6px;
            text-align: center;
        }

        .perf-label {
            font-size: 11px;
            text-transform: uppercase;
            color: var(--ft-text-light);
            margin-bottom: 8px;
        }

        .perf-value {
            font-size: 24px;
            font-weight: 700;
            font-family: 'Playfair Display', serif;
        }

        .strategy-card {
            background: linear-gradient(135deg, rgba(0,166,81,0.05) 0%, rgba(0,80,179,0.05) 100%);
            border-left: 4px solid var(--ft-green);
            padding: 20px;
            border-radius: 6px;
        }

        .strategy-arm {
            font-size: 16px;
            font-weight: 700;
            color: var(--ft-primary);
            margin-bottom: 12px;
        }

        .strategy-reason {
            font-size: 14px;
            line-height: 1.6;
            color: var(--ft-text);
            margin-bottom: 16px;
        }

        .gating-facts {
            display: flex;
            flex-direction: column;
            gap: 8px;
        }

        .gating-fact {
            display: flex;
            align-items: center;
            gap: 8px;
            font-size: 13px;
        }

        .gating-fact::before {
            content: '‚úì';
            color: var(--ft-green);
            font-weight: 700;
            font-size: 16px;
        }

        .news-list {
            display: flex;
            flex-direction: column;
            gap: 12px;
            max-height: 300px;
            overflow-y: auto;
        }

        .news-item {
            padding: 12px;
            background: var(--ft-surface);
            border-radius: 6px;
            border-left: 3px solid transparent;
            transition: all 0.2s;
        }

        .news-item:hover {
            border-left-color: var(--ft-accent);
            background: white;
        }

        .news-headline {
            font-size: 14px;
            font-weight: 500;
            margin-bottom: 4px;
        }

        .news-meta {
            font-size: 11px;
            color: var(--ft-text-light);
            display: flex;
            justify-content: space-between;
        }

        .sentiment-badge {
            display: inline-block;
            padding: 2px 8px;
            border-radius: 10px;
            font-size: 10px;
            font-weight: 600;
        }

        .sentiment-badge.positive {
            background: var(--ft-green);
            color: white;
        }

        .sentiment-badge.negative {
            background: var(--ft-red);
            color: white;
        }

        .sentiment-badge.neutral {
            background: var(--ft-border);
            color: var(--ft-text);
        }

        /* Evidence Cards */
        .evidence-panel {
            display: flex;
            flex-direction: column;
            gap: 16px;
        }

        .evidence-test {
            padding: 16px;
            background: var(--ft-surface);
            border-radius: 6px;
            border-left: 3px solid var(--ft-accent);
        }

        .evidence-header {
            display: flex;
            align-items: center;
            gap: 12px;
            margin-bottom: 8px;
        }

        .evidence-name {
            font-size: 14px;
            font-weight: 600;
            color: var(--ft-primary);
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .evidence-badge {
            padding: 2px 8px;
            border-radius: 12px;
            font-size: 11px;
            font-weight: 700;
        }

        .evidence-badge.A {
            background: var(--ft-green);
            color: white;
        }

        .evidence-badge.B {
            background: var(--ft-yellow);
            color: var(--ft-primary);
        }

        .evidence-badge.C {
            background: var(--ft-border);
            color: var(--ft-text);
        }

        .significance-badge {
            padding: 2px 6px;
            background: var(--ft-purple);
            color: white;
            border-radius: 4px;
            font-size: 10px;
            font-weight: 600;
        }

        .evidence-hypothesis {
            font-size: 13px;
            color: var(--ft-text);
            margin-bottom: 8px;
            font-style: italic;
        }

        .evidence-effect {
            display: flex;
            align-items: center;
            gap: 8px;
            margin-bottom: 4px;
        }

        .effect-label {
            font-size: 12px;
            color: var(--ft-text-light);
        }

        .effect-value {
            font-size: 14px;
            font-weight: 600;
            color: var(--ft-primary);
        }

        .effect-ci {
            font-size: 11px;
            color: var(--ft-text-light);
            font-family: 'Courier New', monospace;
        }

        .evidence-pvalue {
            display: flex;
            align-items: center;
            gap: 8px;
            margin-bottom: 4px;
        }

        .pvalue-label {
            font-size: 12px;
            color: var(--ft-text-light);
        }

        .pvalue-value {
            font-size: 14px;
            font-weight: 600;
            color: var(--ft-text);
        }

        .pvalue-value.significant {
            color: var(--ft-green);
        }

        .evidence-notes {
            font-size: 11px;
            color: var(--ft-text-light);
            margin-top: 8px;
            padding-top: 8px;
            border-top: 1px solid var(--ft-border);
        }

        .calibration-metrics {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 12px;
            padding: 16px;
            background: var(--ft-surface);
            border-radius: 6px;
            margin-top: 16px;
        }

        .calibration-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .calibration-label {
            font-size: 12px;
            color: var(--ft-text-light);
        }

        .calibration-value {
            font-size: 14px;
            font-weight: 600;
            color: var(--ft-primary);
        }

        .assumptions-warning {
            padding: 12px;
            background: rgba(255,193,7,0.1);
            border-left: 3px solid var(--ft-yellow);
            border-radius: 4px;
            font-size: 12px;
            color: var(--ft-text);
            margin-top: 16px;
        }

        .empty-state {
            text-align: center;
            padding: 80px 40px;
            color: var(--ft-text-light);
        }

        .empty-state-icon {
            font-size: 64px;
            margin-bottom: 24px;
            opacity: 0.3;
        }

        .empty-state-title {
            font-family: 'Playfair Display', serif;
            font-size: 28px;
            margin-bottom: 12px;
            color: var(--ft-text);
        }

        .loading {
            display: flex;
            justify-content: center;
            align-items: center;
            padding: 80px;
        }

        .spinner {
            width: 48px;
            height: 48px;
            border: 4px solid var(--ft-border);
            border-top-color: var(--ft-accent);
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }

        @keyframes spin {
            to { transform: rotate(360deg); }
        }

        ::-webkit-scrollbar {
            width: 8px;
            height: 8px;
        }

        ::-webkit-scrollbar-track {
            background: var(--ft-surface);
        }

        ::-webkit-scrollbar-thumb {
            background: var(--ft-border);
            border-radius: 4px;
        }

        ::-webkit-scrollbar-thumb:hover {
            background: var(--ft-text-light);
        }
    </style>
</head>
<body>
    <div class="header">
        <h1>Catalyst Radar</h1>
        <div class="header-meta">
            <span id="current-time"></span>
            <span>Enterprise Analytics Platform</span>
        </div>
    </div>

    <div class="container">
        <div class="top-bar">
            <div class="search-group">
                <input type="text" id="ticker-input" class="search-input" placeholder="Enter ticker symbol (e.g., NVDA, TSLA, AAPL)" onkeypress="if(event.key==='Enter') analyzeStock()">
                <button class="btn-primary" onclick="analyzeStock()">Analyze</button>
            </div>
            <div>
                <button class="btn-secondary" onclick="fetchScanList()">Refresh Opportunities</button>
            </div>
        </div>

        <div id="dashboard-content">
            <div class="empty-state">
                <div class="empty-state-icon">üìä</div>
                <div class="empty-state-title">Enterprise Trading Analytics</div>
                <div class="empty-state-text">Enter a ticker symbol above or select from opportunities to begin comprehensive analysis.</div>
            </div>
        </div>
    </div>

    <script>
        const API_BASE = 'http://127.0.0.1:8000';
        let currentAnalysis = null;
        let priceChart = null;
        let rsiChart = null;

        function updateTime() {
            const now = new Date();
            document.getElementById('current-time').textContent = now.toLocaleString('en-US', {
                weekday: 'short',
                month: 'short',
                day: 'numeric',
                hour: '2-digit',
                minute: '2-digit'
            });
        }
        updateTime();
        setInterval(updateTime, 60000);

        // Render Plotly Price Chart
        function renderPriceChart(historyData) {
            if (!historyData || !historyData.data) {
                console.warn('No history data for price chart');
                return;
            }
            
            const chartElement = document.getElementById('price-chart');
            if (!chartElement) {
                console.warn('Price chart element not found');
                return;
            }
            
            if (typeof Plotly === 'undefined') {
                console.error('Plotly library not loaded');
                return;
            }
            
            const data = historyData.data;
            if (!data || data.length === 0) {
                console.warn('Empty data array');
                return;
            }
            
            const dates = data.map(d => d.date);
            const closes = data.map(d => d.close);
            
            // Filter out null values for SMAs
            const sma20Data = data.filter(d => d.sma_20 !== null && d.sma_20 !== undefined);
            const sma50Data = data.filter(d => d.sma_50 !== null && d.sma_50 !== undefined);
            
            const support = historyData.indicators?.support || closes[closes.length - 1];
            const resistance = historyData.indicators?.resistance || closes[closes.length - 1];
            
            // Ensure all values are numeric (filter out any NaN/Inf)
            const validIndices = [];
            for (let i = 0; i < dates.length; i++) {
                if (dates[i] && closes[i] !== null && closes[i] !== undefined && 
                    !isNaN(closes[i]) && isFinite(closes[i])) {
                    validIndices.push(i);
                }
            }
            
            const validDates = validIndices.map(i => dates[i]);
            const validCloses = validIndices.map(i => closes[i]);
            
            // Additional validation: ensure we have at least 2 data points
            if (validDates.length < 2 || validCloses.length < 2) {
                console.error('‚ùå Insufficient valid data points for price chart');
                chartElement.innerHTML = `<div style="padding: 20px; color: var(--ft-text-light);">Insufficient data: need at least 2 data points</div>`;
                return;
            }
            
            const traces = [
                {
                    x: validDates,
                    y: validCloses,
                    type: 'scatter',
                    mode: 'lines',
                    name: 'Close Price',
                    line: { color: '#0050B3', width: 2 },
                    hovertemplate: '<b>%{fullData.name}</b><br>Date: %{x}<br>Price: $%{y:.2f}<extra></extra>'
                }
            ];
            
            // Add SMA20 if available
            if (sma20Data.length > 0) {
                const sma20Dates = sma20Data.map(d => d.date);
                const sma20Values = sma20Data.map(d => d.sma_20).filter(v => v !== null && !isNaN(v) && isFinite(v));
                if (sma20Values.length > 0) {
                    traces.push({
                        x: sma20Dates.slice(-sma20Values.length),
                        y: sma20Values,
                        type: 'scatter',
                        mode: 'lines',
                        name: 'SMA 20',
                        line: { color: '#FF6B35', width: 1.5, dash: 'dot' }
                    });
                }
            }
            
            // Add SMA50 if available
            if (sma50Data.length > 0) {
                const sma50Dates = sma50Data.map(d => d.date);
                const sma50Values = sma50Data.map(d => d.sma_50).filter(v => v !== null && !isNaN(v) && isFinite(v));
                if (sma50Values.length > 0) {
                    traces.push({
                        x: sma50Dates.slice(-sma50Values.length),
                        y: sma50Values,
                        type: 'scatter',
                        mode: 'lines',
                        name: 'SMA 50',
                        line: { color: '#6B46C1', width: 1.5, dash: 'dot' }
                    });
                }
            }
            
            // Add support/resistance lines
            if (validDates.length > 0 && support && resistance && 
                isFinite(support) && isFinite(resistance)) {
                traces.push({
                    x: [validDates[0], validDates[validDates.length - 1]],
                    y: [support, support],
                    type: 'scatter',
                    mode: 'lines',
                    name: 'Support',
                    line: { color: '#00A651', width: 2, dash: 'dash' }
                });
                
                traces.push({
                    x: [validDates[0], validDates[validDates.length - 1]],
                    y: [resistance, resistance],
                    type: 'scatter',
                    mode: 'lines',
                    name: 'Resistance',
                    line: { color: '#DC143C', width: 2, dash: 'dash' }
                });
            }
            
            const layout = {
                title: {
                    text: 'Price Action with Technical Indicators',
                    font: { family: 'Playfair Display', size: 20 },
                    x: 0.5,
                    xanchor: 'center'
                },
                xaxis: { 
                    title: 'Date',
                    showgrid: true,
                    gridcolor: 'rgba(0,0,0,0.1)',
                    zeroline: false
                },
                yaxis: { 
                    title: 'Price ($)',
                    side: 'left',
                    showgrid: true,
                    gridcolor: 'rgba(0,0,0,0.1)',
                    zeroline: false
                },
                hovermode: 'x unified',
                showlegend: true,
                legend: { x: 0, y: 1, bgcolor: 'rgba(255,255,255,0.8)' },
                margin: { l: 60, r: 50, t: 60, b: 60 },
                plot_bgcolor: '#FFFFFF',
                paper_bgcolor: '#FFFFFF',
                font: { family: 'Inter', size: 12, color: '#2E2E2E' }
            };
            
            // Verify container exists and has dimensions
            const containerHeight = chartElement.offsetHeight;
            const containerWidth = chartElement.offsetWidth;
            console.log('Container dimensions:', { width: containerWidth, height: containerHeight });
            
            if (containerHeight === 0 || containerWidth === 0) {
                console.error('‚ùå Chart container has zero dimensions!');
                chartElement.style.height = '450px';
                chartElement.style.width = '100%';
            }
            
            try {
                console.log('Rendering price chart with', traces.length, 'traces');
                console.log('Sample trace data:', {
                    trace1: traces[0] ? { name: traces[0].name, xLength: traces[0].x?.length, yLength: traces[0].y?.length } : null,
                    layout: layout
                });
                
                // Clear any existing plot
                Plotly.purge('price-chart');
                
                // Render with explicit config
                Plotly.newPlot('price-chart', traces, layout, {
                    responsive: true,
                    displayModeBar: true,
                    displaylogo: false,
                    modeBarButtonsToRemove: ['pan2d', 'lasso2d'],
                    autosize: true,
                    frameMargins: 0
                });
                
                // Force resize after render
                setTimeout(() => {
                    Plotly.Plots.resize('price-chart');
                }, 100);
                
                console.log('‚úÖ Price chart rendered');
            } catch (error) {
                console.error('‚ùå Error rendering price chart:', error);
                console.error('Trace data:', traces);
                console.error('Layout:', layout);
                // Show error message in container
                chartElement.innerHTML = `<div style="padding: 20px; color: red;">Chart rendering error: ${error.message}</div>`;
            }
        }

        // Render RSI Chart
        function renderRSIChart(historyData) {
            if (!historyData || !historyData.data) {
                console.warn('No history data for RSI chart');
                return;
            }
            
            const chartElement = document.getElementById('rsi-chart');
            if (!chartElement) {
                console.warn('RSI chart element not found');
                return;
            }
            
            if (typeof Plotly === 'undefined') {
                console.error('Plotly library not loaded');
                return;
            }
            
            const data = historyData.data;
            if (!data || data.length === 0) {
                console.warn('Empty data array for RSI');
                return;
            }
            
            const rsiData = data.filter(d => d.rsi !== null && d.rsi !== undefined);
            if (rsiData.length === 0) {
                console.warn('No RSI data available');
                return;
            }
            
            const rsiDates = rsiData.map(d => d.date);
            const rsi = rsiData.map(d => d.rsi).filter(v => v !== null && !isNaN(v) && isFinite(v));
            
            // Additional validation: ensure we have valid RSI data
            if (rsiDates.length < 2 || rsi.length < 2) {
                console.error('‚ùå Insufficient valid RSI data points');
                chartElement.innerHTML = `<div style="padding: 20px; color: var(--ft-text-light);">Insufficient RSI data: need at least 2 data points</div>`;
                return;
            }
            
            const traces = [
                {
                    x: rsiDates.slice(0, rsi.length), // Match lengths
                    y: rsi,
                    type: 'scatter',
                    mode: 'lines',
                    name: 'RSI(14)',
                    line: { color: '#0050B3', width: 2 },
                    fill: 'tozeroy',
                    fillcolor: 'rgba(0,80,179,0.1)',
                    hovertemplate: '<b>RSI(14)</b><br>Date: %{x}<br>RSI: %{y:.2f}<extra></extra>'
                }
            ];
            
            if (rsiDates.length > 0) {
                traces.push({
                    x: [rsiDates[0], rsiDates[rsiDates.length - 1]],
                    y: [70, 70],
                    type: 'scatter',
                    mode: 'lines',
                    name: 'Overbought (70)',
                    line: { color: '#DC143C', width: 1, dash: 'dash' }
                });
                
                traces.push({
                    x: [rsiDates[0], rsiDates[rsiDates.length - 1]],
                    y: [30, 30],
                    type: 'scatter',
                    mode: 'lines',
                    name: 'Oversold (30)',
                    line: { color: '#00A651', width: 1, dash: 'dash' }
                });
            }
            
            const layout = {
                title: {
                    text: 'RSI(14) Momentum Indicator',
                    font: { family: 'Playfair Display', size: 18 }
                },
                xaxis: { 
                    title: 'Date',
                    showgrid: true,
                    gridcolor: 'rgba(0,0,0,0.1)',
                    zeroline: false
                },
                yaxis: { 
                    title: 'RSI', 
                    range: [0, 100],
                    side: 'left',
                    showgrid: true,
                    gridcolor: 'rgba(0,0,0,0.1)',
                    zeroline: false
                },
                hovermode: 'x unified',
                showlegend: true,
                legend: { x: 0, y: 1, bgcolor: 'rgba(255,255,255,0.8)' },
                margin: { l: 60, r: 50, t: 60, b: 60 },
                plot_bgcolor: '#FFFFFF',
                paper_bgcolor: '#FFFFFF',
                font: { family: 'Inter', size: 12, color: '#2E2E2E' }
            };
            
            // Verify container exists and has dimensions
            const containerHeight = chartElement.offsetHeight;
            const containerWidth = chartElement.offsetWidth;
            console.log('RSI Container dimensions:', { width: containerWidth, height: containerHeight });
            
            if (containerHeight === 0 || containerWidth === 0) {
                console.error('‚ùå RSI Chart container has zero dimensions!');
                chartElement.style.height = '450px';
                chartElement.style.width = '100%';
            }
            
            try {
                console.log('Rendering RSI chart with', traces.length, 'traces');
                console.log('RSI data sample:', {
                    rsiLength: rsi.length,
                    datesLength: rsiDates.length,
                    firstRSI: rsi[0],
                    lastRSI: rsi[rsi.length - 1]
                });
                
                // Clear any existing plot
                Plotly.purge('rsi-chart');
                
                // Render with explicit config
                Plotly.newPlot('rsi-chart', traces, layout, {
                    responsive: true,
                    displayModeBar: true,
                    displaylogo: false,
                    modeBarButtonsToRemove: ['pan2d', 'lasso2d'],
                    autosize: true,
                    frameMargins: 0
                });
                
                // Force resize after render
                setTimeout(() => {
                    Plotly.Plots.resize('rsi-chart');
                }, 100);
                
                console.log('‚úÖ RSI chart rendered');
            } catch (error) {
                console.error('‚ùå Error rendering RSI chart:', error);
                console.error('Trace data:', traces);
                console.error('Layout:', layout);
                // Show error message in container
                chartElement.innerHTML = `<div style="padding: 20px; color: red;">Chart rendering error: ${error.message}</div>`;
            }
        }

        // Render Enterprise Dashboard with all new features
        async function renderAnalysis(data) {
            const content = document.getElementById('dashboard-content');
            const plan = data.plan || {};
            const analysis = data.analysis || {};
            const catalyst = analysis.catalyst || {};
            const strategy = analysis.strategy || {};
            const market = analysis.market || {};
            const news = analysis.news || [];
            const history = analysis.history || {};
            const social = JSON.parse(plan.social_sentiment || '{}');

            const ticker = analysis.ticker || plan.ticker;
            
            // Fetch surge analysis and history data
            let surgeData = null;
            let historyData = null;
            
            try {
                const [surgeRes, historyRes] = await Promise.all([
                    fetch(`${API_BASE}/surge/${ticker}`),
                    fetch(`${API_BASE}/history/${ticker}?days=30`)
                ]);
                
                if (surgeRes.ok) {
                    surgeData = await surgeRes.json();
                    console.log('Surge data loaded:', surgeData);
                } else {
                    console.warn('Surge endpoint failed:', surgeRes.status, surgeRes.statusText);
                }
                
                if (historyRes.ok) {
                    historyData = await historyRes.json();
                    console.log('History data loaded:', historyData ? `${historyData.data?.length || 0} data points` : 'null');
                } else {
                    console.error('History endpoint failed:', historyRes.status, historyRes.statusText);
                    const errorText = await historyRes.text();
                    console.error('Error response:', errorText);
                }
            } catch (e) {
                console.error('Error fetching surge/history:', e);
            }

            // Calculate derived metrics
            const pricePosition = (plan.price_position || 0.5) * 100;
            const volumeSurge = plan.volume_surge_ratio || 1.0;
            const expectedMove = (catalyst.expected_move || 0) * 100;
            const materiality = (catalyst.materiality || 0) * 100;
            
            // Meme signal detection
            const memeSignal = surgeData?.social?.meme_signal || 
                (social.mention_count_total > 50 && social.sentiment_score > 0.5);
            
            // Pattern vs Catalyst analysis
            const patternExpectation = pricePosition > 80 ? 'Breakout Expected' : 
                                      pricePosition < 20 ? 'Bounce Expected' : 'Range Bound';
            const catalystExpectation = catalyst.days_to_event < 7 ? 'High Impact' : 
                                       catalyst.days_to_event < 30 ? 'Moderate Impact' : 'Low Near-term Impact';
            const alignment = (patternExpectation.includes('Breakout') && catalyst.days_to_event < 7) ? 'ALIGNED' :
                             (patternExpectation.includes('Bounce') && catalyst.days_to_event < 30) ? 'ALIGNED' : 'MISALIGNED';

            content.innerHTML = `
                <!-- Decision Bar -->
                <div class="decision-bar">
                    <div class="verdict-badge ${plan.action}">${plan.action}</div>
                    <div>
                        <div class="ticker-display">${ticker}</div>
                        <div style="font-size: 14px; opacity: 0.8; margin-top: 4px;">${strategy.reason || 'No strategy rationale available'}</div>
                    </div>
                    <div class="confidence-meter">
                        <div class="confidence-value">${Math.round((plan.confidence || analysis.llm_confidence || 0.5) * 100)}%</div>
                        <div class="confidence-label">Confidence</div>
                        <div class="confidence-bar">
                            <div class="confidence-fill" style="width: ${(plan.confidence || analysis.llm_confidence || 0.5) * 100}%"></div>
                        </div>
                    </div>
                    <div style="text-align: right;">
                        <div style="font-size: 32px; font-weight: 700; font-family: 'Playfair Display', serif;">$${market.price?.toFixed(2) || plan.entry_price?.toFixed(2) || 'N/A'}</div>
                        <div style="font-size: 12px; opacity: 0.8; margin-top: 4px;">Current Price</div>
                    </div>
                </div>

                <!-- Surge Analysis Card -->
                ${surgeData ? `
                <div class="surge-analysis">
                    <div class="card-header">
                        <div>
                            <div class="card-title">Surge Potential & Room to Run</div>
                            <div class="card-subtitle">Price Increase & Intraday Play Analysis</div>
                        </div>
                    </div>
                    <div class="surge-score ${surgeData.recommendation === 'HIGH_POTENTIAL' ? 'high' : surgeData.recommendation === 'MODERATE' ? 'moderate' : 'low'}">
                        ${surgeData.surge_score}/100
                    </div>
                    <div style="text-align: center; margin-bottom: 20px;">
                        <span style="font-size: 18px; font-weight: 600;">${surgeData.recommendation}</span>
                    </div>
                    <div class="room-to-run">
                        <div class="room-metric">
                            <div class="room-label">Upside to Resistance</div>
                            <div class="room-value" style="color: var(--ft-green);">+${surgeData.room_to_run.upside_to_resistance.toFixed(1)}%</div>
                        </div>
                        <div class="room-metric">
                            <div class="room-label">Intraday Potential</div>
                            <div class="room-value" style="color: var(--ft-orange);">¬±${surgeData.room_to_run.intraday_potential_pct.toFixed(1)}%</div>
                        </div>
                        <div class="room-metric">
                            <div class="room-label">Price Position</div>
                            <div class="room-value">${surgeData.room_to_run.price_position.toFixed(1)}%</div>
                        </div>
                        <div class="room-metric">
                            <div class="room-label">Volume Surge</div>
                            <div class="room-value">${surgeData.momentum.volume_surge.toFixed(2)}x</div>
                        </div>
                    </div>
                </div>
                ` : ''}

                <!-- Pattern vs Catalyst Comparison -->
                <div class="card">
                    <div class="card-header">
                        <div>
                            <div class="card-title">Pattern vs Catalyst Analysis</div>
                            <div class="card-subtitle">What We See vs What We Expect</div>
                        </div>
                        <div style="padding: 8px 16px; background: ${alignment === 'ALIGNED' ? 'var(--ft-green)' : 'var(--ft-orange)'}; color: white; border-radius: 4px; font-size: 12px; font-weight: 600;">
                            ${alignment}
                        </div>
                    </div>
                    <div class="comparison-grid">
                        <div class="comparison-panel">
                            <div class="comparison-title">üìà Technical Pattern</div>
                            <div class="comparison-item">
                                <span class="comparison-label">Price Position</span>
                                <span class="comparison-value">${pricePosition.toFixed(1)}%</span>
                            </div>
                            <div class="comparison-item">
                                <span class="comparison-label">Breakout Status</span>
                                <span class="comparison-value">${plan.breakout_flag ? '‚úì Breakout' : 'No Breakout'}</span>
                            </div>
                            <div class="comparison-item">
                                <span class="comparison-label">Volume Surge</span>
                                <span class="comparison-value">${volumeSurge.toFixed(2)}x</span>
                            </div>
                            <div class="comparison-item">
                                <span class="comparison-label">RSI(14)</span>
                                <span class="comparison-value">${market.rsi14?.toFixed(1) || 'N/A'}</span>
                            </div>
                            <div style="margin-top: 12px; padding-top: 12px; border-top: 1px solid var(--ft-border);">
                                <strong>Expectation:</strong> ${patternExpectation}
                            </div>
                        </div>
                        <div class="comparison-panel">
                            <div class="comparison-title">üéØ Catalyst Event</div>
                            <div class="comparison-item">
                                <span class="comparison-label">Event Type</span>
                                <span class="comparison-value">${catalyst.event_type || 'N/A'}</span>
                            </div>
                            <div class="comparison-item">
                                <span class="comparison-label">Days to Event</span>
                                <span class="comparison-value">${Math.round(catalyst.days_to_event || 0)}</span>
                            </div>
                            <div class="comparison-item">
                                <span class="comparison-label">Expected Move</span>
                                <span class="comparison-value">${expectedMove.toFixed(1)}%</span>
                            </div>
                            <div class="comparison-item">
                                <span class="comparison-label">Materiality</span>
                                <span class="comparison-value">${materiality.toFixed(0)}%</span>
                            </div>
                            <div style="margin-top: 12px; padding-top: 12px; border-top: 1px solid var(--ft-border);">
                                <strong>Expectation:</strong> ${catalystExpectation}
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Meme Signal Indicator -->
                ${memeSignal ? `
                <div class="meme-signal active">
                    <div class="meme-icon">üöÄ</div>
                    <div class="meme-text">MEME/SOCIAL MOMENTUM DETECTED</div>
                    <div style="margin-top: 12px; font-size: 14px;">
                        High social media activity (${social.mention_count_total || surgeData?.social?.mention_count || 0} mentions) 
                        with ${((social.sentiment_score || surgeData?.social?.sentiment_score || 0) * 100).toFixed(1)}% positive sentiment.
                        This may be driving price action independent of fundamentals.
                    </div>
                </div>
                ` : social.mention_count_total > 20 ? `
                <div class="meme-signal">
                    <div class="meme-icon">üì±</div>
                    <div class="meme-text">Moderate Social Activity</div>
                    <div style="margin-top: 12px; font-size: 14px;">
                        ${social.mention_count_total || 0} mentions detected. Monitoring for momentum signals.
                    </div>
                </div>
                ` : ''}

                <!-- Main Analytics Grid -->
                <div class="analytics-grid">
                    <div class="analytics-main">
                        <!-- Price Chart with Indicators -->
                        <div class="card">
                            <div class="card-header">
                                <div>
                                    <div class="card-title">Price Action & Technical Indicators</div>
                                    <div class="card-subtitle">30-Day Time Series with Moving Averages & Support/Resistance</div>
                                </div>
                            </div>
                            <div id="price-chart" class="chart-container"></div>
                            <div class="indicator-explanation">
                                <h4>Technical Indicators Explained:</h4>
                                <p><strong>SMA 20:</strong> 20-day Simple Moving Average - Short-term trend direction. Price above = bullish, below = bearish.</p>
                                <p><strong>SMA 50:</strong> 50-day Simple Moving Average - Medium-term trend. Golden cross (SMA20 > SMA50) = bullish signal.</p>
                                <p><strong>Support:</strong> Recent 10-day low - Price level where buying interest may emerge.</p>
                                <p><strong>Resistance:</strong> Recent 10-day high - Price level where selling pressure may occur.</p>
                            </div>
                        </div>

                        <!-- RSI Chart -->
                        <div class="card">
                            <div class="card-header">
                                <div>
                                    <div class="card-title">RSI(14) Momentum Indicator</div>
                                    <div class="card-subtitle">Relative Strength Index - Overbought/Oversold Conditions</div>
                                </div>
                            </div>
                            <div id="rsi-chart" class="chart-container"></div>
                            <div class="indicator-explanation">
                                <h4>RSI Explained:</h4>
                                <p><strong>RSI > 70:</strong> Overbought - Stock may be due for a pullback. Consider selling or tightening stops.</p>
                                <p><strong>RSI < 30:</strong> Oversold - Stock may be due for a bounce. Potential buying opportunity.</p>
                                <p><strong>RSI 30-70:</strong> Neutral range - No extreme conditions. Price action driven by other factors.</p>
                                <p><strong>Current RSI:</strong> ${market.rsi14?.toFixed(1) || 'N/A'} - ${market.rsi14 > 70 ? '‚ö†Ô∏è Overbought' : market.rsi14 < 30 ? '‚úÖ Oversold' : 'Neutral'}</p>
                            </div>
                        </div>

                        <!-- Trade Plan -->
                        <div class="card">
                            <div class="card-header">
                                <div>
                                    <div class="card-title">Trade Execution Plan</div>
                                    <div class="card-subtitle">Entry, Stop, Target & Risk Parameters</div>
                                </div>
                            </div>
                            <div class="trade-plan-grid">
                                <div class="trade-metric">
                                    <div class="trade-metric-label">Entry Price</div>
                                    <div class="trade-metric-value">$${plan.entry_price?.toFixed(2) || 'N/A'}</div>
                                </div>
                                <div class="trade-metric">
                                    <div class="trade-metric-label">Stop Loss</div>
                                    <div class="trade-metric-value" style="color: var(--ft-red);">$${plan.stop_price?.toFixed(2) || 'N/A'}</div>
                                </div>
                                <div class="trade-metric">
                                    <div class="trade-metric-label">Target Price</div>
                                    <div class="trade-metric-value" style="color: var(--ft-green);">$${plan.target_price?.toFixed(2) || 'N/A'}</div>
                                </div>
                                <div class="trade-metric">
                                    <div class="trade-metric-label">Timeout</div>
                                    <div class="trade-metric-value">${plan.timeout_days || 5} days</div>
                                </div>
                            </div>
                        </div>

                        <!-- AI Reasoning -->
                        <div class="reasoning-section">
                            <div class="card-title" style="margin-bottom: 16px;">AI Trader Analysis</div>
                            <div class="reasoning-text">${plan.reason || 'No reasoning provided by the AI.'}</div>
                        </div>

                        <!-- Strategy Rationale -->
                        <div class="strategy-card">
                            <div class="strategy-arm">${strategy.selected_arm || 'N/A'}</div>
                            <div class="strategy-reason">${strategy.reason || 'No strategy rationale available.'}</div>
                            <div class="gating-facts">
                                ${(strategy.gating_facts || []).map(fact => `<div class="gating-fact">${fact}</div>`).join('')}
                            </div>
                        </div>
                    </div>

                    <div class="analytics-sidebar">
                        <!-- Catalyst Timeline -->
                        <div class="catalyst-card">
                            <div class="catalyst-header">
                                <div class="catalyst-type">${catalyst.event_type || 'N/A'}</div>
                                <div>
                                    <div class="catalyst-days">${Math.round(catalyst.days_to_event || 0)}</div>
                                    <div style="font-size: 11px; text-transform: uppercase; opacity: 0.8;">Days</div>
                                </div>
                            </div>
                            <div style="display: grid; grid-template-columns: repeat(3, 1fr); gap: 12px; margin-top: 16px;">
                                <div style="text-align: center; padding: 12px; background: white; border-radius: 4px;">
                                    <div style="font-size: 10px; text-transform: uppercase; color: var(--ft-text-light); margin-bottom: 4px;">Expected Move</div>
                                    <div style="font-size: 18px; font-weight: 700;">${expectedMove.toFixed(1)}%</div>
                                </div>
                                <div style="text-align: center; padding: 12px; background: white; border-radius: 4px;">
                                    <div style="font-size: 10px; text-transform: uppercase; color: var(--ft-text-light); margin-bottom: 4px;">Materiality</div>
                                    <div style="font-size: 18px; font-weight: 700;">${materiality.toFixed(0)}%</div>
                                </div>
                                <div style="text-align: center; padding: 12px; background: white; border-radius: 4px;">
                                    <div style="font-size: 10px; text-transform: uppercase; color: var(--ft-text-light); margin-bottom: 4px;">Rank</div>
                                    <div style="font-size: 18px; font-weight: 700;">${Math.round(catalyst.rank || 0)}</div>
                                </div>
                            </div>
                        </div>

                        <!-- Market Context -->
                        <div class="card">
                            <div class="card-header">
                                <div>
                                    <div class="card-title">Market Context</div>
                                    <div class="card-subtitle">Technical Indicators</div>
                                </div>
                            </div>
                            <div class="perf-grid">
                                <div class="perf-stat">
                                    <div class="perf-label">RSI(14)</div>
                                    <div class="perf-value" style="color: ${market.rsi14 > 70 ? 'var(--ft-red)' : market.rsi14 < 30 ? 'var(--ft-green)' : 'var(--ft-primary)'};">
                                        ${market.rsi14?.toFixed(1) || 'N/A'}
                                    </div>
                                </div>
                                <div class="perf-stat">
                                    <div class="perf-label">ATR(14)</div>
                                    <div class="perf-value">$${market.atr14?.toFixed(2) || 'N/A'}</div>
                                </div>
                                <div class="perf-stat">
                                    <div class="perf-label">Spread</div>
                                    <div class="perf-value">$${market.spread?.toFixed(4) || 'N/A'}</div>
                                </div>
                                <div class="perf-stat">
                                    <div class="perf-label">Volatility</div>
                                    <div class="perf-value">${(plan.rolling_volatility_10d * 100 || 0).toFixed(2)}%</div>
                                </div>
                            </div>
                        </div>

                        <!-- Social Sentiment -->
                        <div class="card">
                            <div class="card-header">
                                <div>
                                    <div class="card-title">Social Sentiment</div>
                                    <div class="card-subtitle">StockTwits Momentum</div>
                                </div>
                            </div>
                            <div class="volume-metrics">
                                <div class="volume-metric">
                                    <div class="volume-label">Mentions</div>
                                    <div class="volume-value">${social.mention_count_total || 0}</div>
                                </div>
                                <div class="volume-metric">
                                    <div class="volume-label">Sentiment Score</div>
                                    <div class="volume-value" style="color: ${(social.sentiment_score || 0) > 0 ? 'var(--ft-green)' : 'var(--ft-red)'};">
                                        ${((social.sentiment_score || 0) * 100).toFixed(1)}%
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- Performance History -->
                        <div class="card">
                            <div class="card-header">
                                <div>
                                    <div class="card-title">Historical Performance</div>
                                    <div class="card-subtitle">Backtest Statistics</div>
                                </div>
                            </div>
                            <div class="perf-grid">
                                <div class="perf-stat">
                                    <div class="perf-label">Hit Rate</div>
                                    <div class="perf-value" style="color: ${(history.hit_rate || 0) > 0.5 ? 'var(--ft-green)' : 'var(--ft-red)'};">
                                        ${((history.hit_rate || 0) * 100).toFixed(1)}%
                                    </div>
                                </div>
                                <div class="perf-stat">
                                    <div class="perf-label">Samples</div>
                                    <div class="perf-value">${history.samples || 0}</div>
                                </div>
                                <div class="perf-stat">
                                    <div class="perf-label">Avg Win</div>
                                    <div class="perf-value" style="color: var(--ft-green);">
                                        ${((history.avg_win || 0) * 100).toFixed(2)}%
                                    </div>
                                </div>
                                <div class="perf-stat">
                                    <div class="perf-label">Avg Loss</div>
                                    <div class="perf-value" style="color: var(--ft-red);">
                                        ${((history.avg_loss || 0) * 100).toFixed(2)}%
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- Recent News -->
                        <div class="card">
                            <div class="card-header">
                                <div>
                                    <div class="card-title">Recent News</div>
                                    <div class="card-subtitle">Market Activity & Sentiment</div>
                                </div>
                            </div>
                            <div class="news-list">
                                ${news.length > 0 ? news.slice(0, 5).map(item => `
                                    <div class="news-item">
                                        <div class="news-headline">${item.headline || 'No headline'}</div>
                                        <div class="news-meta">
                                            <span>${new Date(item.timestamp).toLocaleDateString()}</span>
                                            <span class="sentiment-badge ${item.sentiment > 0 ? 'positive' : item.sentiment < 0 ? 'negative' : 'neutral'}">
                                                ${item.sentiment > 0 ? 'Positive' : item.sentiment < 0 ? 'Negative' : 'Neutral'}
                                            </span>
                                        </div>
                                    </div>
                                `).join('') : '<div style="text-align: center; padding: 20px; color: var(--ft-text-light);">No recent news available</div>'}
                            </div>
                        </div>

                        <!-- Evidence Analysis -->
                        ${analysis.evidence ? `
                        <div class="card" style="border-left: 4px solid var(--ft-purple);">
                            <div class="card-header">
                                <div>
                                    <div class="card-title">Evidence & Statistical Tests</div>
                                    <div class="card-subtitle">Rigorous Analysis with Uncertainty Quantification</div>
                                </div>
                            </div>
                            <div class="evidence-panel">
                                ${analysis.evidence.tests && analysis.evidence.tests.length > 0 ? analysis.evidence.tests.map((test, idx) => {
                                    const badge = test.p_value !== null ? formatSignificanceBadge(test.p_value) : '';
                                    const grade = computeEffectGrade(test.p_value, test.effect_size);
                                    return `
                                        <div class="evidence-test">
                                            <div class="evidence-header">
                                                <span class="evidence-name">${test.name}</span>
                                                <span class="evidence-badge ${grade}">${grade}</span>
                                                ${badge ? `<span class="significance-badge">${badge}</span>` : ''}
                                            </div>
                                            <div class="evidence-hypothesis">${test.hypothesis}</div>
                                            ${test.effect_size !== null ? `
                                                <div class="evidence-effect">
                                                    <span class="effect-label">Effect Size:</span>
                                                    <span class="effect-value">${test.effect_size.toFixed(3)}</span>
                                                    ${test.ci_low !== null && test.ci_high !== null ? `
                                                        <span class="effect-ci">[${test.ci_low.toFixed(3)}, ${test.ci_high.toFixed(3)}]</span>
                                                    ` : ''}
                                                </div>
                                            ` : ''}
                                            ${test.p_value !== null ? `
                                                <div class="evidence-pvalue">
                                                    <span class="pvalue-label">p-value:</span>
                                                    <span class="pvalue-value ${test.p_value < 0.05 ? 'significant' : ''}">${test.p_value.toFixed(4)}</span>
                                                </div>
                                            ` : ''}
                                            ${test.notes ? `<div class="evidence-notes">${test.notes}</div>` : ''}
                                        </div>
                                    `;
                                }).join('') : '<div style="padding: 20px; text-align: center; color: var(--ft-text-light);">No statistical tests available</div>'}
                                
                                ${analysis.evidence && analysis.evidence.calibration ? `
                                    <div class="calibration-metrics">
                                        <div class="calibration-item">
                                            <span class="calibration-label">ECE:</span>
                                            <span class="calibration-value">${(analysis.evidence.calibration.ece || 0).toFixed(3)}</span>
                                        </div>
                                        <div class="calibration-item">
                                            <span class="calibration-label">Brier Score:</span>
                                            <span class="calibration-value">${(analysis.evidence.calibration.brier || 0).toFixed(3)}</span>
                                        </div>
                                        ${analysis.evidence.calibration.n_samples !== undefined ? `
                                        <div class="calibration-item">
                                            <span class="calibration-label">Samples:</span>
                                            <span class="calibration-value">${analysis.evidence.calibration.n_samples}</span>
                                        </div>
                                        ` : ''}
                                        ${analysis.evidence.calibration.raw_confidence !== undefined && analysis.evidence.calibration.calibrated_confidence !== undefined ? `
                                        <div class="calibration-item" style="grid-column: 1 / -1; padding-top: 12px; border-top: 1px solid var(--ft-border);">
                                            <span class="calibration-label">Confidence:</span>
                                            <span class="calibration-value">
                                                Raw: ${(analysis.evidence.calibration.raw_confidence * 100).toFixed(1)}% ‚Üí 
                                                Calibrated: ${(analysis.evidence.calibration.calibrated_confidence * 100).toFixed(1)}%
                                            </span>
                                        </div>
                                        ` : ''}
                                    </div>
                                ` : ''}
                                
                                ${analysis.evidence && analysis.evidence.assumptions && analysis.evidence.assumptions.missing && analysis.evidence.assumptions.missing.length > 0 ? `
                                    <div class="assumptions-warning">
                                        <strong>Missing Data:</strong> ${analysis.evidence.assumptions.missing.join(', ')}
                                    </div>
                                ` : ''}
                            </div>
                        </div>
                        ` : ''}
                    </div>
                </div>
            `;

            // Debug: Log evidence data structure
            console.log('Evidence data structure:', {
                hasEvidence: !!analysis.evidence,
                evidenceKeys: analysis.evidence ? Object.keys(analysis.evidence) : [],
                tests: analysis.evidence?.tests?.length || 0,
                calibration: analysis.evidence?.calibration || null
            });
            
            // Render charts after DOM is updated - use requestAnimationFrame for better timing
            if (historyData && historyData.data && historyData.data.length > 0) {
                // Wait for DOM to be fully rendered
                requestAnimationFrame(() => {
                    setTimeout(() => {
                        console.log('Rendering charts with data:', {
                            ticker: historyData.ticker,
                            dataPoints: historyData.data.length,
                            hasIndicators: !!historyData.indicators,
                            sampleDate: historyData.data[0]?.date,
                            sampleClose: historyData.data[0]?.close
                        });
                        
                        // Verify chart containers exist
                        const priceChartEl = document.getElementById('price-chart');
                        const rsiChartEl = document.getElementById('rsi-chart');
                        
                        if (!priceChartEl || !rsiChartEl) {
                            console.error('‚ùå Chart containers not found in DOM');
                            return;
                        }
                        
                        // Ensure containers have dimensions
                        if (priceChartEl.offsetHeight === 0) {
                            priceChartEl.style.height = '450px';
                        }
                        if (rsiChartEl.offsetHeight === 0) {
                            rsiChartEl.style.height = '450px';
                        }
                        
                        try {
                            renderPriceChart(historyData);
                            renderRSIChart(historyData);
                            console.log('‚úÖ Charts rendered successfully');
                        } catch (chartError) {
                            console.error('‚ùå Chart rendering error:', chartError);
                            console.error('Stack trace:', chartError.stack);
                        }
                    }, 300); // Reduced delay but still enough for DOM
                });
            } else {
                console.warn('‚ö†Ô∏è No history data available for charts:', {
                    hasHistoryData: !!historyData,
                    hasData: !!historyData?.data,
                    dataLength: historyData?.data?.length || 0
                });
            }
        }

        function formatSignificanceBadge(pValue) {
            if (pValue === null) return '';
            if (pValue < 0.001) return '***';
            if (pValue < 0.01) return '**';
            if (pValue < 0.05) return '*';
            return 'ns';
        }

        function computeEffectGrade(pValue, effectSize) {
            if (pValue === null || effectSize === null) return 'C';
            if (pValue < 0.01 && Math.abs(effectSize) > 0.3) return 'A';
            if (pValue < 0.05 && Math.abs(effectSize) > 0.1) return 'B';
            return 'C';
        }

        async function analyzeStock(ticker) {
            if (!ticker) {
                const input = document.getElementById('ticker-input');
                ticker = input.value.trim().toUpperCase();
            }
            if (!ticker) return;

            const content = document.getElementById('dashboard-content');
            content.innerHTML = '<div class="loading"><div class="spinner"></div></div>';

            try {
                const response = await fetch(`${API_BASE}/analyze/${ticker}`);
                if (!response.ok) throw new Error(`Analysis failed: ${response.statusText}`);

                const data = await response.json();
                currentAnalysis = data;
                await renderAnalysis(data);

            } catch (error) {
                content.innerHTML = `
                    <div class="empty-state">
                        <div class="empty-state-icon">‚ö†Ô∏è</div>
                        <div class="empty-state-title">Analysis Error</div>
                        <div class="empty-state-text">${error.message}</div>
                    </div>
                `;
            }
        }

        async function fetchScanList() {
            try {
                const response = await fetch(`${API_BASE}/scan`);
                const data = await response.json();
                console.log('Opportunities loaded:', data.length);
            } catch (error) {
                console.error('Failed to fetch opportunities:', error);
            }
        }

        fetchScanList();
    </script>
</body>
</html>
